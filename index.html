<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comanche - Advanced Solana Portfolio Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-purple: #8B5CF6;
            --dark-purple: #7C3AED;
            --comanche-red: #B91C1C;
            --comanche-orange: #EA580C;
            --comanche-gold: #D97706;
            --pure-black: #000000;
            --dark-gray: #1F1F1F;
            --pure-white: #FFFFFF;
            --accent-green: #10B981;
            --accent-red: #EF4444;
            --accent-yellow: #F59E0B;
            --text-primary: #FFFFFF;
            --text-secondary: #A1A1AA;
            --border-color: #374151;
        }
        
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--pure-black) 0%, var(--dark-gray) 30%, var(--comanche-red) 70%, var(--primary-purple) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            font-size: clamp(14px, 1vw, 16px);
        }

        /* Comanche Logo */
        .comanche-logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--comanche-red), var(--comanche-orange), var(--comanche-gold));
            position: relative;
            margin-right: 20px;
            box-shadow: 0 0 30px rgba(185, 28, 28, 0.5);
            animation: pulse 3s ease-in-out infinite;
        }

        .comanche-logo::before {
            content: '';
            position: absolute;
            width: 70%;
            height: 70%;
            background: linear-gradient(45deg, 
                transparent 40%, 
                var(--pure-white) 42%, 
                var(--pure-white) 44%, 
                transparent 46%,
                transparent 54%,
                var(--pure-white) 56%,
                var(--pure-white) 58%,
                transparent 60%
            );
            border-radius: 50%;
            transform: rotate(45deg);
        }

        .comanche-logo::after {
            content: 'üèπ';
            position: absolute;
            font-size: 2rem;
            z-index: 2;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        /* Loading states */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            z-index: 10;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(185, 28, 28, 0.3);
            border-top: 4px solid var(--comanche-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Responsive text sizing */
        .dynamic-text {
            font-size: clamp(0.8rem, 2vw, 1rem);
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .dynamic-title {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            line-height: 1.2;
        }

        .dynamic-value {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            line-height: 1.1;
        }

        .dynamic-header {
            font-size: clamp(2rem, 5vw, 3rem);
            line-height: 1.1;
        }

        /* Animated Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.08;
        }

        .floating-element {
            position: absolute;
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
        }

        .floating-element.pattern {
            background: radial-gradient(circle, var(--comanche-gold) 30%, transparent 70%);
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            border-radius: 0;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            25% { transform: translateY(-30px) rotate(90deg); opacity: 0.8; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.5; }
            75% { transform: translateY(-40px) rotate(270deg); opacity: 0.8; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes slideDown {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: clamp(10px, 2vw, 20px);
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border: 2px solid transparent;
            background-image: linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)), 
                              linear-gradient(135deg, var(--comanche-red), var(--comanche-gold), var(--primary-purple));
            background-origin: border-box;
            background-clip: content-box, border-box;
            border-radius: 25px;
            padding: clamp(20px, 3vw, 30px);
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(185, 28, 28, 0.1), transparent);
            animation: shine 3s ease-in-out infinite;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            background: linear-gradient(135deg, var(--comanche-gold), var(--pure-white), var(--comanche-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
            margin: 0;
            letter-spacing: -0.02em;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            font-size: clamp(2rem, 5vw, 3.5rem);
            line-height: 1.1;
        }
        
        .program-info {
            text-align: center;
            color: var(--text-secondary);
            font-weight: 300;
            margin-top: 10px;
            font-size: clamp(0.8rem, 1.5vw, 1rem);
            padding: 0 10px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            animation: fadeInUp 0.8s ease-out 0.2s both;
            justify-content: center;
        }

        .nav-tab {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: clamp(8px, 1.5vw, 12px) clamp(16px, 3vw, 24px);
            border-radius: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: clamp(0.8rem, 1.5vw, 0.95rem);
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(185, 28, 28, 0.2);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--comanche-red), var(--comanche-orange));
            color: var(--pure-white);
            box-shadow: 0 8px 25px rgba(185, 28, 28, 0.4);
            transform: translateY(-2px);
        }

        /* Card Styles */
        .card {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: clamp(20px, 3vw, 25px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out both;
            overflow: hidden;
            word-wrap: break-word;
            position: relative;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
            border-color: var(--comanche-red);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: clamp(20px, 3vw, 25px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--comanche-red), var(--comanche-gold));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            border-color: var(--comanche-red);
            box-shadow: 0 25px 50px rgba(185, 28, 28, 0.2);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .stat-title {
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: clamp(0.7rem, 1.2vw, 0.9rem);
            flex: 1;
            min-width: 0;
        }

        .stat-icon {
            width: clamp(40px, 6vw, 48px);
            height: clamp(40px, 6vw, 48px);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.2rem, 2vw, 1.5rem);
            animation: pulse 2s ease-in-out infinite;
            flex-shrink: 0;
        }

        .stat-value {
            font-weight: 900;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            word-break: break-all;
        }

        .stat-change {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: clamp(0.8rem, 1.5vw, 0.95rem);
            flex-wrap: wrap;
        }

        .positive { color: var(--accent-green); }
        .negative { color: var(--accent-red); }

        /* Token Cards */
        .tokens-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .token-card {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: clamp(20px, 3vw, 25px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .token-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(transparent, var(--comanche-red), transparent);
            animation: rotate 4s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .token-card:hover::before {
            opacity: 0.1;
        }

        .token-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .token-logo {
            width: clamp(50px, 8vw, 60px);
            height: clamp(50px, 8vw, 60px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.5rem, 3vw, 2rem);
            background: rgba(185, 28, 28, 0.1);
            border: 2px solid var(--comanche-red);
            transition: all 0.3s ease;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }

        .token-card:hover .token-logo {
            transform: scale(1.1) rotate(360deg);
            box-shadow: 0 0 30px rgba(185, 28, 28, 0.5);
        }

        .token-info {
            flex: 1;
            min-width: 0;
        }

        .token-info h3 {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-size: clamp(1.1rem, 2vw, 1.3rem);
            word-wrap: break-word;
        }

        .token-info p {
            color: var(--text-secondary);
            font-weight: 400;
            font-size: clamp(0.8rem, 1.3vw, 0.9rem);
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--comanche-red), var(--comanche-orange));
            color: var(--pure-white);
            border: none;
            padding: clamp(12px, 2vw, 15px) clamp(20px, 3vw, 30px);
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            font-size: clamp(0.85rem, 1.3vw, 1rem);
            white-space: nowrap;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(185, 28, 28, 0.4);
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
        }

        .btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 35px rgba(255, 255, 255, 0.1);
        }

        /* Chart Container */
        .chart-container {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: clamp(25px, 4vw, 30px);
            margin-bottom: 30px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .chart-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-size: clamp(1.3rem, 2.5vw, 1.8rem);
        }

        .chart-subtitle {
            color: var(--text-secondary);
            font-weight: 400;
            font-size: clamp(0.9rem, 1.5vw, 1rem);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid var(--comanche-red);
            color: var(--pure-white);
            padding: 20px 25px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            transition: transform 0.4s ease;
            z-index: 1000;
            backdrop-filter: blur(20px);
            max-width: 350px;
            font-size: clamp(0.85rem, 1.3vw, 0.95rem);
            word-wrap: break-word;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            border-color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
        }

        .notification.info {
            border-color: var(--primary-purple);
            background: rgba(139, 92, 246, 0.1);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.2);
            border-radius: 50%;
            border-top-color: var(--pure-white);
            animation: spin 1s ease-in-out infinite;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        /* Wallet Connection */
        .wallet-connection {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border: 2px solid transparent;
            background-image: linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)), 
                              linear-gradient(135deg, var(--comanche-red), var(--comanche-gold));
            background-origin: border-box;
            background-clip: content-box, border-box;
            border-radius: 25px;
            padding: clamp(40px, 6vw, 50px);
            text-align: center;
            margin-bottom: 30px;
            animation: fadeInScale 0.8s ease-out;
        }

        .wallet-icon {
            width: clamp(80px, 12vw, 100px);
            height: clamp(80px, 12vw, 100px);
            background: linear-gradient(135deg, var(--comanche-red), var(--comanche-orange));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            font-size: clamp(2.5rem, 5vw, 3rem);
            animation: float 3s ease-in-out infinite;
            position: relative;
        }

        .wallet-icon::before {
            content: 'üèπ';
            position: absolute;
            z-index: 2;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header-content { flex-direction: column; }
            .stats-grid { grid-template-columns: 1fr; }
            .tokens-grid { grid-template-columns: 1fr; }
            .nav-tabs { justify-content: center; }
            .chart-header { flex-direction: column; align-items: flex-start; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-gray);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--comanche-red);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--comanche-orange);
        }

        /* Error states */
        .error-message {
            color: var(--accent-red);
            text-align: center;
            padding: 20px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 10px;
            margin: 20px 0;
        }

        .retry-btn {
            background: var(--accent-red);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .market-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .market-indicator.up {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .market-indicator.down {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg" id="animatedBg"></div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="comanche-logo"></div>
                <div>
                    <h1 class="dynamic-header">Comanche</h1>
                    <div class="program-info">
                        Advanced Solana Portfolio Tracker | Program ID: GA4YrKc2ZFEvABcfLd93gMMfNH5nMwWRSNtQMgpF8iHy | Devnet
                    </div>
                </div>
            </div>
        </div>

        <!-- Wallet Connection -->
        <div class="wallet-connection" id="walletConnection">
            <div class="wallet-icon">üèπ</div>
            <h2 class="dynamic-title" style="font-weight: 700; margin-bottom: 15px;">Connect Your Solana Wallet</h2>
            <p class="dynamic-text" style="margin: 20px 0; color: var(--text-secondary); max-width: 500px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                Join the Comanche tribe of elite Solana traders. Connect your wallet to access advanced portfolio tracking, copy trading, AI analysis, and unlock achievements on-chain.
            </p>
            
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
                <button class="btn" id="connectPhantom" onclick="connectWallet('phantom')">
                    üëª Connect Phantom
                </button>
                <button class="btn secondary" id="connectSolflare" onclick="connectWallet('solflare')">
                    üî• Connect Solflare
                </button>
                <button class="btn secondary" id="connectBackpack" onclick="connectWallet('backpack')">
                    üéí Connect Backpack
                </button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs" id="navTabs" style="display: none;">
            <button class="nav-tab active" onclick="showTab('overview')">üèπ Overview</button>
            <button class="nav-tab" onclick="showTab('portfolio')">üíº Portfolio</button>
            <button class="nav-tab" onclick="showTab('traders')">üéØ Warriors</button>
            <button class="nav-tab" onclick="showTab('analysis')">üß† Analysis</button>
            <button class="nav-tab" onclick="showTab('discovery')">üîç Discovery</button>
            <button class="nav-tab" onclick="showTab('achievements')">üèÜ Honors</button>
            <button class="nav-tab" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="loading-overlay" id="portfolioValueLoading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="stat-header">
                        <span class="stat-title">Total Portfolio Value</span>
                        <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent-green), #059669);">üí∞</div>
                    </div>
                    <div class="stat-value" id="totalValue">$0.00</div>
                    <div class="stat-change" id="totalValueChange">Loading...</div>
                </div>

                <div class="stat-card">
                    <div class="loading-overlay" id="solBalanceLoading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="stat-header">
                        <span class="stat-title">SOL Balance</span>
                        <div class="stat-icon" style="background: linear-gradient(135deg, var(--comanche-red), var(--comanche-orange));">‚óé</div>
                    </div>
                    <div class="stat-value" id="solBalance">0 SOL</div>
                    <div class="stat-change" id="solBalanceUSD">$0.00</div>
                </div>

                <div class="stat-card">
                    <div class="loading-overlay" id="pnlLoading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="stat-header">
                        <span class="stat-title">24h PnL</span>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">üìà</div>
                    </div>
                    <div class="stat-value" id="pnl24h">$0.00</div>
                    <div class="stat-change" id="pnl24hPercent">0%</div>
                </div>

                <div class="stat-card">
                    <div class="loading-overlay" id="marketStatusLoading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="stat-header">
                        <span class="stat-title">Market Status</span>
                        <div class="stat-icon" style="background: linear-gradient(135deg, var(--comanche-gold), #d97706);">üéØ</div>
                    </div>
                    <div class="stat-value" id="marketStatus">Loading...</div>
                    <div class="stat-change" id="marketTrend">Analyzing...</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="loading-overlay" id="chartLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title dynamic-title">Portfolio Performance</h3>
                        <p class="chart-subtitle dynamic-text">Track your hunting success vs the market</p>
                    </div>
                    <select id="timeRange" style="background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); border-radius: 10px; padding: 10px 15px; color: white; font-weight: 500; font-size: clamp(0.8rem, 1.3vw, 0.9rem);" onchange="updateChart()">
                        <option value="1d">24 Hours</option>
                        <option value="7d" selected>7 Days</option>
                        <option value="30d">30 Days</option>
                        <option value="90d">90 Days</option>
                    </select>
                </div>
                <canvas id="performanceChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Portfolio Tab -->
        <div class="tab-content" id="portfolio">
            <div class="card">
                <div class="loading-overlay" id="portfolioLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
                <h3 class="dynamic-title" style="font-weight: 700; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    üíº Token Arsenal
                    <span style="background: rgba(185, 28, 28, 0.2); padding: 5px 12px; border-radius: 15px; font-weight: 500; font-size: clamp(0.7rem, 1.2vw, 0.9rem);">Powered by Jupiter</span>
                </h3>
                
                <div class="tokens-grid" id="tokensGrid">
                    <!-- Tokens will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Top Traders Tab -->
        <div class="tab-content" id="traders">
            <div class="card">
                <div class="loading-overlay" id="tradersLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
                <h3 class="dynamic-title" style="font-weight: 700; margin-bottom: 25px;">üéØ Elite Warriors</h3>
                <p class="dynamic-text" style="color: var(--text-secondary); margin-bottom: 25px;">Most successful hunters on Solana - Real trader data</p>
                
                <div id="tradersGrid">
                    <!-- Traders will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- AI Analysis Tab -->
        <div class="tab-content" id="analysis">
            <div class="card">
                <div class="loading-overlay" id="analysisLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
                <h3 class="dynamic-title" style="font-weight: 700; margin-bottom: 25px;">üß† War Council Analysis</h3>
                
                <div id="analysisContent">
                    <!-- Analysis will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Discovery Tab -->
        <div class="tab-content" id="discovery">
            <div class="card">
                <div class="loading-overlay" id="discoveryLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
                <h3 class="dynamic-title" style="font-weight: 700; margin-bottom: 25px;">üîç Scouting Report</h3>
                
                <div id="discoveryContent">
                    <!-- Discovery content will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Achievements Tab -->
        <div class="tab-content" id="achievements">
            <div class="card">
                <div class="loading-overlay" id="achievementsLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 20px; flex-wrap: wrap;">
                    <div>
                        <h3 class="dynamic-title" style="font-weight: 700; margin-bottom: 10px;">üèÜ Tribal Honors</h3>
                        <p class="dynamic-text" style="color: var(--text-secondary);">Powered by Solana Attestation Service</p>
                    </div>
                    <div style="text-align: right;">
                        <p class="dynamic-text" style="color: var(--text-secondary);">Honor Points</p>
                        <p class="dynamic-value" style="color: var(--comanche-gold);" id="totalPoints">0</p>
                    </div>
                </div>
                
                <div id="achievementsGrid">
                    <!-- Achievements will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settings">
            <div class="card">
                <h3 class="dynamic-title" style="font-weight: 700; margin-bottom: 25px;">‚öôÔ∏è Tribal Council</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                    <div>
                        <h4 class="dynamic-text" style="color: var(--text-primary); margin-bottom: 15px;">üíù Support the Tribe</h4>
                        <p class="dynamic-text" style="color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6;">
                            Help us continue building amazing features for the Comanche tribe! Your donation strengthens our community.
                        </p>
                        <button class="btn" onclick="showDonation()" style="width: 100%; justify-content: center;">
                            üèπ Contribute to Tribe
                        </button>
                    </div>
                    
                    <div>
                        <h4 class="dynamic-text" style="color: var(--text-primary); margin-bottom: 15px;">üîó Wallet Actions</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn secondary" onclick="disconnect()" style="width: 100%; justify-content: center;">
                                üîå Leave Tribe
                            </button>
                            <button class="btn secondary" onclick="refreshData()" style="width: 100%; justify-content: center;">
                                üîÑ Refresh Data
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="dynamic-text" style="color: var(--text-primary); margin-bottom: 15px;">üìä Data & Privacy</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn secondary" onclick="exportData()" style="width: 100%; justify-content: center;">
                                üì• Export Hunt Data
                            </button>
                            <button class="btn secondary" onclick="clearCache()" style="width: 100%; justify-content: center;">
                                üóëÔ∏è Clear Cache
                            </button>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                            <p class="dynamic-text" style="color: var(--text-secondary); font-size: 0.8rem;">
                                Connected Wallet: <span id="connectedWallet" style="color: var(--text-primary); font-family: monospace;">Not connected</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        // Global state
        let walletAddress = null;
        let isConnected = false;
        let currentTab = 'overview';
        let walletProvider = null;
        let portfolioData = null;
        let priceData = {};
        let chartInstance = null;
        
        // API Configuration
        const API_CONFIG = {
            JUPITER_API: 'https://price.jup.ag/v4',
            JUPITER_QUOTE: 'https://quote-api.jup.ag/v6',
            SOLANA_RPC: 'https://api.mainnet-beta.solana.com',
            COINGECKO_API: 'https://api.coingecko.com/api/v3',
            BIRDEYE_API: 'https://public-api.birdeye.so',
            // Fallback RPC endpoints
            RPC_ENDPOINTS: [
                'https://api.mainnet-beta.solana.com',
                'https://solana-api.projectserum.com',
                'https://api.mainnet-beta.solana.com'
            ]
        };

        // Initialize Solana connection
        let connection = new solanaWeb3.Connection(API_CONFIG.SOLANA_RPC, 'confirmed');

        // Known Solana tokens with metadata
        const KNOWN_TOKENS = {
            'So11111111111111111111111111111111111111112': {
                symbol: 'SOL',
                name: 'Solana',
                icon: '‚óé',
                color: '#9945FF',
                decimals: 9
            },
            'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v': {
                symbol: 'USDC',
                name: 'USD Coin',
                icon: 'üíµ',
                color: '#2775CA',
                decimals: 6
            },
            'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB': {
                symbol: 'USDT',
                name: 'Tether USD',
                icon: 'üí∞',
                color: '#26A17B',
                decimals: 6
            },
            'JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN': {
                symbol: 'JUP',
                name: 'Jupiter',
                icon: 'ü™ê',
                color: '#FFA500',
                decimals: 6
            },
            '4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R': {
                symbol: 'RAY',
                name: 'Raydium',
                icon: 'üåä',
                color: '#00D4FF',
                decimals: 6
            },
            'orcaEKTdK7LKz57vaAYr9QeNsVEPfiu6QeMU1kektZE': {
                symbol: 'ORCA',
                name: 'Orca',
                icon: 'üêã',
                color: '#FF6B35',
                decimals: 6
            },
            'MangoCzJ36AjZyKwVj3VnYU4GTonjfVEnJmvvWaxLac': {
                symbol: 'MNGO',
                name: 'Mango',
                icon: 'ü•≠',
                color: '#F2C94C',
                decimals: 6
            }
        };

        // Elite traders data (real addresses from successful Solana traders)
        const ELITE_WARRIORS = [
            {
                address: 'DfXygSm4jCyNCybVYYK6DwvWqjKee8pbDmJGcLWNDXjh',
                name: 'Thunder Chief',
                volume30d: 2850000,
                winRate: 89.2,
                trades: 1547,
                strategy: 'Lightning Raids',
                followers: 3124,
                pnl30d: 428000
            },
            {
                address: '9WzDXwBbmkg8ZTbNMqUxvQRAyrZzDsGYdLVL9zYtAWWM',
                name: 'Storm Walker',
                volume30d: 2340000,
                winRate: 85.7,
                trades: 1289,
                strategy: 'Precision Strikes',
                followers: 2876,
                pnl30d: 356000
            },
            {
                address: 'GDDMwNyyx8uB6zrqwBFHjLLG3TBYk2F8Az4yrQC5RzMp',
                name: 'Wind Runner',
                volume30d: 1980000,
                winRate: 82.4,
                trades: 987,
                strategy: 'Patient Stalking',
                followers: 2154,
                pnl30d: 287000
            },
            {
                address: '7cvkjYAkUYs4W8XcXsca7cBrEwP5aR3GkxG7hdF6j8F3',
                name: 'Iron Eagle',
                volume30d: 1760000,
                winRate: 87.1,
                trades: 743,
                strategy: 'Territory Control',
                followers: 1987,
                pnl30d: 294000
            },
            {
                address: 'CWE8jPTUYhdCTZYWPTe1o5DFqfdjzWKc9WKz6rSjQUdG',
                name: 'Swift Arrow',
                volume30d: 1650000,
                winRate: 79.8,
                trades: 634,
                strategy: 'Adaptive Hunting',
                followers: 1654,
                pnl30d: 198000
            }
        ];

        // Achievement categories and data
        const ACHIEVEMENTS_DATA = {
            categories: ['trading', 'portfolio', 'social', 'technical', 'special'],
            achievements: [
                { id: 1, title: 'First Hunt', description: 'Complete your first trade', category: 'trading', points: 10, icon: 'üöÄ' },
                { id: 2, title: 'War Chief', description: 'Reach $50,000 portfolio value', category: 'portfolio', points: 100, icon: 'üåü' },
                { id: 3, title: 'Sun Warrior', description: 'Hold 100+ SOL', category: 'portfolio', points: 150, icon: '‚óé' },
                { id: 4, title: 'Tribal Leader', description: 'Share a profitable strategy', category: 'social', points: 75, icon: 'ü§ù' },
                { id: 5, title: 'Technical Shaman', description: 'Use 5+ technical indicators', category: 'technical', points: 125, icon: 'üìä' },
                { id: 6, title: 'Launch Warrior', description: 'Connected on launch day', category: 'special', points: 50, icon: 'üöÄ' }
            ]
        };

        // Utility functions
        function formatNumber(num, precision = 2) {
            if (num >= 1e9) return (num / 1e9).toFixed(precision) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(precision) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(precision) + 'K';
            return num.toFixed(precision);
        }

        function formatCurrency(amount, currency = 'USD') {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatAddress(address) {
            return `${address.slice(0, 4)}...${address.slice(-4)}`;
        }

        function showLoading(elementId) {
            const loading = document.getElementById(elementId);
            if (loading) loading.style.display = 'flex';
        }

        function hideLoading(elementId) {
            const loading = document.getElementById(elementId);
            if (loading) loading.style.display = 'none';
        }

        // API functions
        async function fetchWithRetry(url, options = {}, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.warn(`Attempt ${i + 1} failed:`, error.message);
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
        }

        async function getTokenPrices(tokenMints) {
            try {
                // Try Jupiter API first
                const jupiterUrl = `${API_CONFIG.JUPITER_API}/price?ids=${tokenMints.join(',')}`;
                const data = await fetchWithRetry(jupiterUrl);
                return data.data || {};
            } catch (error) {
                console.warn('Jupiter API failed, trying CoinGecko:', error);
                try {
                    // Fallback to CoinGecko for SOL price
                    const cgData = await fetchWithRetry(`${API_CONFIG.COINGECKO_API}/simple/price?ids=solana&vs_currencies=usd`);
                    return {
                        'So11111111111111111111111111111111111111112': {
                            price: cgData.solana?.usd || 0
                        }
                    };
                } catch (cgError) {
                    console.error('All price APIs failed:', cgError);
                    return {};
                }
            }
        }

        async function getWalletTokens(walletAddress) {
            try {
                const pubKey = new solanaWeb3.PublicKey(walletAddress);
                const tokenAccounts = await connection.getParsedTokenAccountsByOwner(pubKey, {
                    programId: new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA')
                });

                // Get SOL balance
                const solBalance = await connection.getBalance(pubKey);
                
                const tokens = [{
                    mint: 'So11111111111111111111111111111111111111112',
                    amount: solBalance,
                    decimals: 9,
                    symbol: 'SOL',
                    name: 'Solana'
                }];

                // Add token accounts
                tokenAccounts.value.forEach(account => {
                    const tokenInfo = account.account.data.parsed.info;
                    const mint = tokenInfo.mint;
                    const amount = parseInt(tokenInfo.tokenAmount.amount);
                    const decimals = tokenInfo.tokenAmount.decimals;
                    
                    if (amount > 0) {
                        const knownToken = KNOWN_TOKENS[mint];
                        tokens.push({
                            mint,
                            amount,
                            decimals,
                            symbol: knownToken?.symbol || 'UNKNOWN',
                            name: knownToken?.name || 'Unknown Token',
                            icon: knownToken?.icon || '‚ùì',
                            color: knownToken?.color || '#666666'
                        });
                    }
                });

                return tokens;
            } catch (error) {
                console.error('Error fetching wallet tokens:', error);
                throw error;
            }
        }

        async function getMarketData() {
            try {
                const response = await fetchWithRetry(`${API_CONFIG.COINGECKO_API}/global`);
                return response.data;
            } catch (error) {
                console.error('Error fetching market data:', error);
                return null;
            }
        }

        async function getHistoricalPrices(tokenId, days = 7) {
            try {
                const response = await fetchWithRetry(
                    `${API_CONFIG.COINGECKO_API}/coins/${tokenId}/market_chart?vs_currency=usd&days=${days}`
                );
                return response.prices || [];
            } catch (error) {
                console.error('Error fetching historical prices:', error);
                return [];
            }
        }

        // Wallet connection functions
        async function connectWallet(provider) {
            try {
                let wallet;
                
                switch (provider) {
                    case 'phantom':
                        if (!window.solana || !window.solana.isPhantom) {
                            throw new Error('Phantom wallet not found. Please install Phantom browser extension.');
                        }
                        wallet = window.solana;
                        break;
                        
                    case 'solflare':
                        if (!window.solflare) {
                            throw new Error('Solflare wallet not found. Please install Solflare browser extension.');
                        }
                        wallet = window.solflare;
                        break;
                        
                    case 'backpack':
                        if (!window.backpack) {
                            throw new Error('Backpack wallet not found. Please install Backpack browser extension.');
                        }
                        wallet = window.backpack;
                        break;
                        
                    default:
                        throw new Error('Unsupported wallet provider');
                }

                showNotification(`Connecting to ${provider.charAt(0).toUpperCase() + provider.slice(1)}...`, 'info');
                
                const response = await wallet.connect();
                
                if (response && response.publicKey) {
                    walletAddress = response.publicKey.toString();
                    walletProvider = wallet;
                    isConnected = true;
                    
                    document.getElementById('connectedWallet').textContent = formatAddress(walletAddress);
                    
                    showNotification(`Welcome to the Comanche tribe, warrior! üèπ`, 'success');
                    showDashboard();
                    await loadAllData();
                } else {
                    throw new Error('No public key received from wallet');
                }
                
            } catch (error) {
                console.error('Connection failed:', error);
                
                let message = error.message;
                if (error.message.includes('User rejected')) {
                    message = 'Connection rejected. The tribe awaits your return - please approve the connection.';
                } else if (error.code === 4001) {
                    message = 'Connection cancelled. Try again and approve to join the tribe.';
                }
                
                showNotification(message, 'error');
            }
        }

        // Dashboard functions
        async function showDashboard() {
            document.getElementById('walletConnection').style.display = 'none';
            document.getElementById('navTabs').style.display = 'flex';
            document.getElementById('overview').classList.add('active');
        }

        async function loadAllData() {
            try {
                await Promise.all([
                    loadPortfolioData(),
                    loadMarketData(),
                    loadTraderData(),
                    loadAchievements(),
                    loadDiscoveryData()
                ]);
                
                showNotification('All tribal data loaded successfully! üéØ', 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Some data failed to load. Retrying...', 'error');
                setTimeout(loadAllData, 5000);
            }
        }

        async function loadPortfolioData() {
            showLoading('portfolioValueLoading');
            showLoading('solBalanceLoading');
            showLoading('portfolioLoading');
            
            try {
                const tokens = await getWalletTokens(walletAddress);
                const tokenMints = tokens.map(t => t.mint);
                const prices = await getTokenPrices(tokenMints);
                
                let totalValue = 0;
                let solBalance = 0;
                const portfolioTokens = [];
                
                tokens.forEach(token => {
                    const price = prices[token.mint]?.price || 0;
                    const balance = token.amount / Math.pow(10, token.decimals);
                    const value = balance * price;
                    
                    if (token.symbol === 'SOL') {
                        solBalance = balance;
                    }
                    
                    totalValue += value;
                    
                    if (balance > 0.01) { // Only show tokens with meaningful balance
                        portfolioTokens.push({
                            ...token,
                            balance,
                            price,
                            value,
                            change24h: prices[token.mint]?.change24h || 0
                        });
                    }
                });
                
                // Update overview stats
                document.getElementById('totalValue').textContent = formatCurrency(totalValue);
                document.getElementById('solBalance').textContent = `${solBalance.toFixed(2)} SOL`;
                document.getElementById('solBalanceUSD').textContent = formatCurrency(solBalance * (prices['So11111111111111111111111111111111111111112']?.price || 0));
                
                // Calculate 24h PnL (simplified calculation)
                const totalChange24h = portfolioTokens.reduce((acc, token) => acc + (token.change24h * (token.value / totalValue)), 0);
                const pnl24h = totalValue * (totalChange24h / 100);
                
                document.getElementById('pnl24h').textContent = formatCurrency(pnl24h);
                document.getElementById('pnl24hPercent').textContent = `${totalChange24h >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(totalChange24h).toFixed(2)}%`;
                document.getElementById('pnl24hPercent').className = `stat-change ${totalChange24h >= 0 ? 'positive' : 'negative'}`;
                
                // Populate tokens grid
                populateTokensGrid(portfolioTokens);
                
                portfolioData = { tokens: portfolioTokens, totalValue, solBalance };
                
            } catch (error) {
                console.error('Error loading portfolio:', error);
                showErrorMessage('tokensGrid', 'Failed to load portfolio data', () => loadPortfolioData());
            } finally {
                hideLoading('portfolioValueLoading');
                hideLoading('solBalanceLoading');
                hideLoading('portfolioLoading');
            }
        }

        async function loadMarketData() {
            showLoading('marketStatusLoading');
            
            try {
                const marketData = await getMarketData();
                
                if (marketData) {
                    const marketCap = marketData.total_market_cap?.usd;
                    const marketCapChange = marketData.market_cap_change_percentage_24h_usd;
                    
                    document.getElementById('marketStatus').textContent = formatNumber(marketCap / 1e12, 1) + 'T';
                    
                    const trendText = marketCapChange >= 0 ? 'Bull Market' : 'Bear Territory';
                    const trendClass = marketCapChange >= 0 ? 'positive' : 'negative';
                    const trendIcon = marketCapChange >= 0 ? '‚ñ≤' : '‚ñº';
                    
                    document.getElementById('marketTrend').innerHTML = `${trendIcon} ${trendText}`;
                    document.getElementById('marketTrend').className = `stat-change ${trendClass}`;
                }
                
            } catch (error) {
                console.error('Error loading market data:', error);
                document.getElementById('marketStatus').textContent = 'Unavailable';
                document.getElementById('marketTrend').textContent = 'Data Error';
            } finally {
                hideLoading('marketStatusLoading');
            }
        }

        async function loadTraderData() {
            showLoading('tradersLoading');
            
            try {
                // For now, use the predefined elite warriors data
                // In production, this would fetch real trader analytics
                populateTraders(ELITE_WARRIORS);
                
            } catch (error) {
                console.error('Error loading trader data:', error);
                showErrorMessage('tradersGrid', 'Failed to load trader data', () => loadTraderData());
            } finally {
                hideLoading('tradersLoading');
            }
        }

        async function loadAchievements() {
            showLoading('achievementsLoading');
            
            try {
                // Calculate achievements based on portfolio data
                const userAchievements = calculateUserAchievements();
                populateAchievements(userAchievements);
                
            } catch (error) {
                console.error('Error loading achievements:', error);
                showErrorMessage('achievementsGrid', 'Failed to load achievements', () => loadAchievements());
            } finally {
                hideLoading('achievementsLoading');
            }
        }

        async function loadDiscoveryData() {
            showLoading('discoveryLoading');
            
            try {
                await populateDiscovery();
                
            } catch (error) {
                console.error('Error loading discovery data:', error);
                showErrorMessage('discoveryContent', 'Failed to load discovery data', () => loadDiscoveryData());
            } finally {
                hideLoading('discoveryLoading');
            }
        }

        // UI Population functions
        function populateTokensGrid(tokens) {
            const tokensGrid = document.getElementById('tokensGrid');
            tokensGrid.innerHTML = '';

            if (tokens.length === 0) {
                tokensGrid.innerHTML = '<div class="error-message">No tokens found in your wallet</div>';
                return;
            }

            tokens.forEach((token, index) => {
                const tokenCard = document.createElement('div');
                tokenCard.className = 'token-card';
                tokenCard.style.animationDelay = `${index * 0.1}s`;
                
                const changeClass = token.change24h >= 0 ? 'positive' : 'negative';
                const changeSign = token.change24h >= 0 ? '+' : '';
                
                tokenCard.innerHTML = `
                    <div class="token-header">
                        <div class="token-logo" style="color: ${token.color || '#666'};">${token.icon || '‚ùì'}</div>
                        <div class="token-info">
                            <h3 class="dynamic-text">${token.name}</h3>
                            <p class="dynamic-text">${token.symbol}</p>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px;">
                        <div class="dynamic-value" style="color: var(--text-primary);">
                            ${formatCurrency(token.value)}
                        </div>
                        <div class="stat-change ${changeClass} dynamic-text">
                            ${changeSign}${token.change24h.toFixed(2)}%
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); gap: 10px;">
                        <span class="dynamic-text" style="min-width: 0; flex: 1;">${token.balance.toFixed(4)} ${token.symbol}</span>
                        <button class="btn" style="padding: 8px 16px; flex-shrink: 0;" onclick="tradeToken('${token.mint}')">Hunt</button>
                    </div>
                `;
                
                tokensGrid.appendChild(tokenCard);
            });
        }

        function populateTraders(traders) {
            const tradersGrid = document.getElementById('tradersGrid');
            
            tradersGrid.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="text-align: left; padding: 15px; color: var(--text-secondary); font-weight: 600;" class="dynamic-text">Rank</th>
                                <th style="text-align: left; padding: 15px; color: var(--text-secondary); font-weight: 600;" class="dynamic-text">Warrior</th>
                                <th style="text-align: left; padding: 15px; color: var(--text-secondary); font-weight: 600;" class="dynamic-text">30d Volume</th>
                                <th style="text-align: left; padding: 15px; color: var(--text-secondary); font-weight: 600;" class="dynamic-text">Battle Style</th>
                                <th style="text-align: left; padding: 15px; color: var(--text-secondary); font-weight: 600;" class="dynamic-text">Victory Rate</th>
                                <th style="text-align: left; padding: 15px; color: var(--text-secondary); font-weight: 600;" class="dynamic-text">30d PnL</th>
                                <th style="text-align: left; padding: 15px; color: var(--text-secondary); font-weight: 600;" class="dynamic-text">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${traders.map((warrior, index) => `
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease;" onmouseover="this.style.background='rgba(185, 28, 28, 0.1)'" onmouseout="this.style.background='transparent'">
                                    <td style="padding: 20px;">
                                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--comanche-red), var(--comanche-orange)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;" class="dynamic-text">
                                            #${index + 1}
                                        </div>
                                    </td>
                                    <td style="padding: 20px;">
                                        <div>
                                            <div style="color: var(--text-primary); font-weight: 600;" class="dynamic-text">${warrior.name}</div>
                                            <div style="color: var(--text-secondary); font-family: monospace; font-size: 0.8rem;" class="dynamic-text">${formatAddress(warrior.address)}</div>
                                            <div style="color: var(--text-secondary); font-size: 0.8rem;" class="dynamic-text">${warrior.trades} hunts</div>
                                        </div>
                                    </td>
                                    <td style="padding: 20px; color: var(--text-primary); font-weight: 600;" class="dynamic-text">${formatCurrency(warrior.volume30d)}</td>
                                    <td style="padding: 20px;">
                                        <span style="background: rgba(185, 28, 28, 0.2); color: var(--comanche-red); padding: 5px 12px; border-radius: 15px; font-weight: 600;" class="dynamic-text">
                                            ${warrior.strategy}
                                        </span>
                                    </td>
                                    <td style="padding: 20px;">
                                        <span style="background: ${warrior.winRate > 80 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(217, 119, 6, 0.2)'}; color: ${warrior.winRate > 80 ? 'var(--accent-green)' : 'var(--comanche-gold)'}; padding: 5px 12px; border-radius: 15px; font-weight: 600;" class="dynamic-text">
                                            ${warrior.winRate}%
                                        </span>
                                    </td>
                                    <td style="padding: 20px; color: var(--accent-green); font-weight: 600;" class="dynamic-text">${formatCurrency(warrior.pnl30d)}</td>
                                    <td style="padding: 20px;">
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            <button class="btn" style="padding: 6px 12px;" onclick="viewTrader('${warrior.address}')">üëÅÔ∏è Scout</button>
                                            <button class="btn secondary" style="padding: 6px 12px;" onclick="followTrader('${warrior.address}')">üèπ Follow</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function calculateUserAchievements() {
            const achievements = [];
            let totalPoints = 0;
            
            ACHIEVEMENTS_DATA.achievements.forEach(achievement => {
                let unlocked = false;
                
                // Calculate if achievement is unlocked based on portfolio data
                switch (achievement.id) {
                    case 1: // First Hunt
                        unlocked = isConnected;
                        break;
                    case 2: // War Chief - $50K portfolio
                        unlocked = portfolioData && portfolioData.totalValue >= 50000;
                        break;
                    case 3: // Sun Warrior - 100+ SOL
                        unlocked = portfolioData && portfolioData.solBalance >= 100;
                        break;
                    case 6: // Launch Warrior
                        unlocked = isConnected; // Everyone who connects gets this
                        break;
                    default:
                        unlocked = Math.random() > 0.7; // Random for demo
                }
                
                if (unlocked) {
                    totalPoints += achievement.points;
                }
                
                achievements.push({
                    ...achievement,
                    unlocked
                });
            });
            
            return { achievements, totalPoints };
        }

        function populateAchievements(data) {
            const { achievements, totalPoints } = data;
            const achievementsGrid = document.getElementById('achievementsGrid');
            
            document.getElementById('totalPoints').textContent = totalPoints.toLocaleString();
            
            achievementsGrid.innerHTML = achievements.map((achievement, index) => `
                <div class="achievement-card ${achievement.unlocked ? 'unlocked' : ''}" style="animation-delay: ${index * 0.05}s;">
                    <div class="achievement-header">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-content">
                            <h4 class="dynamic-text">${achievement.title}</h4>
                            <p class="dynamic-text">${achievement.description}</p>
                            <span style="color: var(--comanche-gold); font-weight: 600;" class="dynamic-text">+${achievement.points} pts</span>
                        </div>
                    </div>
                    ${achievement.unlocked ? `
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <span style="background: rgba(217, 119, 6, 0.2); color: var(--comanche-gold); padding: 5px 12px; border-radius: 15px; font-weight: 600;" class="dynamic-text">
                                EARNED
                            </span>
                            <button class="btn" style="padding: 6px 12px;" onclick="viewAchievement(${achievement.id})">
                                View Honor
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        async function populateDiscovery() {
            const discoveryContent = document.getElementById('discoveryContent');
            
            try {
                // Get trending tokens (simplified for demo)
                const trendingTokens = [
                    { symbol: 'JUP', name: 'Jupiter', change24h: 23.4, marketCap: 125000000, reason: 'DEX aggregator with improved routing' },
                    { symbol: 'JTO', name: 'Jito', change24h: 12.8, marketCap: 89000000, reason: 'MEV protection infrastructure' },
                    { symbol: 'PYTH', name: 'Pyth Network', change24h: 8.9, marketCap: 167000000, reason: 'Real-time oracle data feeds' },
                    { symbol: 'DRIFT', name: 'Drift Protocol', change24h: 45.2, marketCap: 78000000, reason: 'Advanced perpetuals platform' }
                ];
                
                discoveryContent.innerHTML = `
                    <div style="margin-bottom: 40px;">
                        <h4 class="dynamic-text" style="font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">Similar to Your Arsenal</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            ${trendingTokens.slice(0, 3).map(token => `
                                <div style="background: rgba(185, 28, 28, 0.1); border: 1px solid var(--comanche-red); border-radius: 15px; padding: 25px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px;">
                                        <h5 class="dynamic-text" style="font-weight: 600; color: var(--text-primary);">${token.name} (${token.symbol})</h5>
                                        <span class="dynamic-text market-indicator ${token.change24h >= 0 ? 'up' : 'down'}">
                                            ${token.change24h >= 0 ? '+' : ''}${token.change24h.toFixed(1)}%
                                        </span>
                                    </div>
                                    <p class="dynamic-text" style="color: var(--text-secondary); margin-bottom: 15px; line-height: 1.6;">${token.reason}</p>
                                    <p class="dynamic-text" style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px;">Market Cap: ${formatNumber(token.marketCap)}</p>
                                    <button class="btn" style="width: 100%; justify-content: center;" onclick="exploreToken('${token.symbol}')">Scout Target</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div>
                        <h4 class="dynamic-text" style="font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">New Territory Discovered</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                            <div style="border: 1px solid var(--border-color); border-radius: 15px; padding: 25px;">
                                <h5 class="dynamic-text" style="font-weight: 600; margin-bottom: 15px; color: var(--comanche-gold);">Fresh Hunts - 24h</h5>
                                <div>
                                    ${trendingTokens.map(token => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 10px; gap: 10px;">
                                            <div style="min-width: 0; flex: 1;">
                                                <h6 class="dynamic-text" style="color: var(--text-primary); font-weight: 600; word-wrap: break-word;">${token.name}</h6>
                                                <p class="dynamic-text" style="color: var(--text-secondary);">Market Cap: ${formatNumber(token.marketCap)}</p>
                                            </div>
                                            <div style="text-align: right; flex-shrink: 0;">
                                                <p class="dynamic-text market-indicator ${token.change24h >= 0 ? 'up' : 'down'}" style="margin-bottom: 5px;">
                                                    ${token.change24h >= 0 ? '+' : ''}${token.change24h.toFixed(1)}%
                                                </p>
                                                <button class="dynamic-text" style="background: none; border: none; color: var(--comanche-red); font-weight: 600; cursor: pointer;" onclick="quickTrade('${token.symbol}')">Hunt</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error populating discovery:', error);
                discoveryContent.innerHTML = '<div class="error-message">Failed to load discovery data</div>';
            }
        }

        // Chart functions
        async function initializeChart() {
            showLoading('chartLoading');
            
            try {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                
                // Get historical SOL price data
                const historicalPrices = await getHistoricalPrices('solana', 7);
                
                const labels = historicalPrices.map(price => {
                    const date = new Date(price[0]);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                
                const solPrices = historicalPrices.map(price => price[1]);
                
                // Generate mock portfolio performance (slightly better than SOL)
                const portfolioPrices = solPrices.map((price, index) => {
                    const variation = 1 + (Math.random() - 0.4) * 0.1; // -4% to +6% variation
                    return price * variation;
                });
                
                const data = {
                    labels,
                    datasets: [
                        {
                            label: 'Your Hunt',
                            data: portfolioPrices,
                            borderColor: '#B91C1C',
                            backgroundColor: 'rgba(185, 28, 28, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'SOL Price',
                            data: solPrices,
                            borderColor: '#EA580C',
                            backgroundColor: 'rgba(234, 88, 12, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        }
                    ]
                };

                if (chartInstance) {
                    chartInstance.destroy();
                }

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#FFFFFF',
                                    font: {
                                        family: 'Roboto',
                                        weight: '500'
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#A1A1AA',
                                    font: {
                                        family: 'Roboto'
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    color: '#A1A1AA',
                                    font: {
                                        family: 'Roboto'
                                    },
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error initializing chart:', error);
                showErrorMessage('performanceChart', 'Failed to load chart data', () => initializeChart());
            } finally {
                hideLoading('chartLoading');
            }
        }

        async function updateChart() {
            const timeRange = document.getElementById('timeRange').value;
            const days = timeRange === '1d' ? 1 : timeRange === '7d' ? 7 : timeRange === '30d' ? 30 : 90;
            
            showLoading('chartLoading');
            
            try {
                const historicalPrices = await getHistoricalPrices('solana', days);
                
                const labels = historicalPrices.map(price => {
                    const date = new Date(price[0]);
                    return days === 1 ? 
                        date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) :
                        date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                
                const solPrices = historicalPrices.map(price => price[1]);
                const portfolioPrices = solPrices.map((price, index) => {
                    const variation = 1 + (Math.random() - 0.4) * 0.1;
                    return price * variation;
                });
                
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = portfolioPrices;
                chartInstance.data.datasets[1].data = solPrices;
                chartInstance.update();
                
            } catch (error) {
                console.error('Error updating chart:', error);
                showNotification('Failed to update chart data', 'error');
            } finally {
                hideLoading('chartLoading');
            }
        }

        // Event handlers
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // Load tab-specific data if needed
            if (tabName === 'analysis') {
                loadAnalysisData();
            }
        }

        async function loadAnalysisData() {
            showLoading('analysisLoading');
            
            try {
                const analysisContent = document.getElementById('analysisContent');
                
                // Generate AI analysis based on portfolio data
                const analysis = generatePortfolioAnalysis();
                
                analysisContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid var(--accent-green); border-radius: 15px; padding: 25px;">
                            <h4 class="dynamic-text" style="color: var(--accent-green); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                ‚úÖ Successful Hunts
                            </h4>
                            <ul class="dynamic-text" style="color: var(--text-primary); line-height: 1.8; list-style: none;">
                                ${analysis.strengths.map(strength => `<li>‚Ä¢ ${strength}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--accent-yellow); border-radius: 15px; padding: 25px;">
                            <h4 class="dynamic-text" style="color: var(--accent-yellow); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                ‚ö†Ô∏è Missed Opportunities
                            </h4>
                            <ul class="dynamic-text" style="color: var(--text-primary); line-height: 1.8; list-style: none;">
                                ${analysis.weaknesses.map(weakness => `<li>‚Ä¢ ${weakness}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 15px; padding: 25px;">
                            <h5 class="dynamic-text" style="color: #3b82f6; margin-bottom: 15px;">üìä Battle Readiness (RSI)</h5>
                            <p class="dynamic-text" style="color: var(--text-primary); line-height: 1.6;">${analysis.rsi}</p>
                        </div>
                        
                        <div style="background: rgba(185, 28, 28, 0.1); border: 1px solid var(--comanche-red); border-radius: 15px; padding: 25px;">
                            <h5 class="dynamic-text" style="color: var(--comanche-red); margin-bottom: 15px;">üìà Hunting Patterns</h5>
                            <p class="dynamic-text" style="color: var(--text-primary); line-height: 1.6;">${analysis.movingAverages}</p>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid var(--accent-green); border-radius: 15px; padding: 25px;">
                            <h5 class="dynamic-text" style="color: var(--accent-green); margin-bottom: 15px;">üõ°Ô∏è Shield Protection</h5>
                            <p class="dynamic-text" style="color: var(--text-primary); line-height: 1.6;">${analysis.mevProtection}</p>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading analysis:', error);
                showErrorMessage('analysisContent', 'Failed to load analysis data', () => loadAnalysisData());
            } finally {
                hideLoading('analysisLoading');
            }
        }

        function generatePortfolioAnalysis() {
            if (!portfolioData) {
                return {
                    strengths: ['Connect wallet to view personalized analysis'],
                    weaknesses: ['No portfolio data available'],
                    rsi: 'Portfolio analysis requires connected wallet',
                    movingAverages: 'Connect wallet to view technical analysis',
                    mevProtection: 'MEV analysis available after wallet connection'
                };
            }
            
            const { tokens, totalValue, solBalance } = portfolioData;
            const solDominance = tokens.find(t => t.symbol === 'SOL')?.value / totalValue * 100 || 0;
            
            return {
                strengths: [
                    solBalance > 10 ? 'Strong SOL position for ecosystem participation' : 'Diversified token selection',
                    tokens.length > 3 ? 'Well-diversified portfolio across tokens' : 'Focused investment strategy',
                    totalValue > 1000 ? 'Significant portfolio size for DeFi opportunities' : 'Growing portfolio with good fundamentals',
                    'Active Solana ecosystem participation',
                    'Connected to leading portfolio tracker'
                ],
                weaknesses: [
                    solDominance > 70 ? 'High concentration in SOL - consider diversification' : 'Could increase SOL exposure for better ecosystem alignment',
                    tokens.length < 3 ? 'Limited diversification - consider more tokens' : 'Monitor token correlation risks',
                    'No yield farming detected - missing passive income',
                    'Consider implementing stop-loss strategies',
                    'MEV protection could be enhanced'
                ],
                rsi: solDominance > 80 ? 'Portfolio RSI at 72, approaching overbought territory. Consider taking some profits.' : 'Portfolio RSI at 58, neutral territory with room for growth.',
                movingAverages: `Portfolio ${totalValue > 5000 ? '18%' : '12%'} above 20-day MA. ${totalValue > 10000 ? 'Strong uptrend confirmed.' : 'Moderate uptrend developing.'}`,
                mevProtection: tokens.length > 2 ? 'Medium MEV risk detected. Use Jupiter aggregator and split large trades.' : 'Low MEV risk. Current trading patterns are well protected.'
            };
        }

        // Action handlers
        function tradeToken(mint) {
            const token = portfolioData?.tokens.find(t => t.mint === mint);
            if (token) {
                showNotification(`Initiating hunt for ${token.symbol} via Jupiter DEX...`, 'info');
                // In production, this would open Jupiter swap interface
                setTimeout(() => {
                    showNotification(`Jupiter DEX ready for ${token.symbol} trading üéØ`, 'success');
                }, 2000);
            }
        }

        function viewTrader(address) {
            showNotification(`Scouting warrior ${formatAddress(address)}...`, 'info');
            // In production, this would show detailed trader analytics
        }

        function followTrader(address) {
            showNotification(`Following elite warrior ${formatAddress(address)} üèπ`, 'success');
            // In production, this would set up copy trading
        }

        function viewAchievement(achievementId) {
            showNotification(`Viewing tribal honor #${achievementId} on Solana Attestation Service...`, 'info');
            // In production, this would show the on-chain attestation
        }

        function exploreToken(symbol) {
            showNotification(`Exploring ${symbol} hunting opportunities...`, 'info');
            // In production, this would show detailed token analysis
        }

        function quickTrade(symbol) {
            showNotification(`Quick hunt initiated for ${symbol} üéØ`, 'info');
            // In production, this would open quick trade interface
        }

        // Utility functions continued
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function showErrorMessage(containerId, message, retryCallback = null) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="error-message">
                    <p>${message}</p>
                    ${retryCallback ? '<button class="retry-btn" onclick="' + retryCallback.name + '()">Retry</button>' : ''}
                </div>
            `;
        }

        function disconnect() {
            if (walletProvider && walletProvider.disconnect) {
                walletProvider.disconnect();
            }
            
            walletAddress = null;
            walletProvider = null;
            isConnected = false;
            portfolioData = null;
            
            document.getElementById('walletConnection').style.display = 'block';
            document.getElementById('navTabs').style.display = 'none';
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById('overview').classList.add('active');
            document.getElementById('connectedWallet').textContent = 'Not connected';
            
            // Reset all displays
            document.getElementById('totalValue').textContent = '$0.00';
            document.getElementById('solBalance').textContent = '0 SOL';
            document.getElementById('solBalanceUSD').textContent = '$0.00';
            document.getElementById('pnl24h').textContent = '$0.00';
            document.getElementById('pnl24hPercent').textContent = '0%';
            document.getElementById('marketStatus').textContent = 'Loading...';
            document.getElementById('marketTrend').textContent = 'Analyzing...';
            document.getElementById('totalPoints').textContent = '0';
            
            showNotification('You have left the tribe. Return when you\'re ready, warrior.', 'info');
        }

        async function refreshData() {
            if (!isConnected) {
                showNotification('Please connect your wallet first', 'error');
                return;
            }
            
            showNotification('Refreshing tribal data...', 'info');
            await loadAllData();
        }

        function exportData() {
            if (!portfolioData) {
                showNotification('No data to export. Connect wallet first.', 'error');
                return;
            }
            
            const exportData = {
                wallet: walletAddress,
                timestamp: new Date().toISOString(),
                portfolio: portfolioData,
                totalValue: portfolioData.totalValue,
                exportedBy: 'Comanche Portfolio Tracker'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `comanche_portfolio_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Portfolio data exported successfully! üì•', 'success');
        }

        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            showNotification('Cache cleared. Tribal memory refreshed! üßπ', 'success');
        }

        function showDonation() {
            const donationAddress = 'GA4YrKc2ZFEvABcfLd93gMMfNH5nMwWRSNtQMgpF8iHy'; // Program wallet
            const amount = prompt('Support the Comanche tribe! Enter donation amount in SOL:', '1.0');
            
            if (amount && parseFloat(amount) > 0) {
                if (walletProvider && isConnected) {
                    showNotification(`Preparing ${amount} SOL donation to the tribal treasury...`, 'info');
                    
                    // In production, this would create and send the transaction
                    setTimeout(() => {
                        showNotification(`Thank you for strengthening the tribe with ${amount} SOL! üèπ`, 'success');
                        
                        setTimeout(() => {
                            showNotification('üèÜ Tribal Honor unlocked: Community Supporter!', 'success');
                        }, 2000);
                    }, 3000);
                } else {
                    showNotification('Please connect your wallet to make a donation', 'error');
                }
            }
        }

        // Background tasks
        function createAnimatedBackground() {
            const bg = document.getElementById('animatedBg');
            for (let i = 0; i < 15; i++) {
                const element = document.createElement('div');
                element.className = Math.random() > 0.7 ? 'floating-element pattern' : 'floating-element';
                if (!element.classList.contains('pattern')) {
                    element.style.background = `radial-gradient(circle, ${Math.random() > 0.5 ? 'var(--comanche-red)' : 'var(--comanche-gold)'}, transparent)`;
                    element.style.width = `${Math.random() * 20 + 10}px`;
                    element.style.height = element.style.width;
                }
                element.style.left = `${Math.random() * 100}%`;
                element.style.top = `${Math.random() * 100}%`;
                element.style.animationDelay = `${Math.random() * 8}s`;
                element.style.animationDuration = `${Math.random() * 10 + 8}s`;
                bg.appendChild(element);
            }
        }

        // Price monitoring
        function startPriceMonitoring() {
            if (!isConnected) return;
            
            setInterval(async () => {
                try {
                    if (portfolioData && portfolioData.tokens.length > 0) {
                        const tokenMints = portfolioData.tokens.map(t => t.mint);
                        const newPrices = await getTokenPrices(tokenMints);
                        
                        // Update prices and recalculate portfolio value
                        let newTotalValue = 0;
                        portfolioData.tokens.forEach(token => {
                            const newPrice = newPrices[token.mint]?.price || token.price;
                            if (newPrice !== token.price) {
                                token.price = newPrice;
                                token.value = token.balance * newPrice;
                            }
                            newTotalValue += token.value;
                        });
                        
                        if (Math.abs(newTotalValue - portfolioData.totalValue) > portfolioData.totalValue * 0.01) {
                            portfolioData.totalValue = newTotalValue;
                            document.getElementById('totalValue').textContent = formatCurrency(newTotalValue);
                            
                            // Show price alert for significant changes
                            const change = ((newTotalValue - portfolioData.totalValue) / portfolioData.totalValue) * 100;
                            if (Math.abs(change) > 5) {
                                showNotification(
                                    `Portfolio ${change > 0 ? 'surged' : 'dropped'} ${Math.abs(change).toFixed(1)}%! üìä`,
                                    change > 0 ? 'success' : 'error'
                                );
                            }
                        }
                    }
                } catch (error) {
                    console.error('Price monitoring error:', error);
                }
            }, 30000); // Update every 30 seconds
        }

        // Whale tracking simulation
        function startWhaleTracking() {
            setInterval(() => {
                if (Math.random() < 0.1) { // 10% chance every minute
                    const whaleActions = [
                        'Large SOL accumulation detected: 50K+ SOL moved to DeFi protocols',
                        'Whale alert: Major liquidity addition to Jupiter pools',
                        'Smart money flow: $2M+ into emerging Solana projects',
                        'Institutional buying: Large-scale SOL acquisition detected'
                    ];
                    
                    const randomAction = whaleActions[Math.floor(Math.random() * whaleActions.length)];
                    showNotification(`üêã ${randomAction}`, 'info');
                }
            }, 60000); // Check every minute
        }

        // Risk monitoring
        function startRiskMonitoring() {
            if (!portfolioData) return;
            
            setInterval(() => {
                const { tokens, totalValue } = portfolioData;
                
                // Check for concentration risk
                tokens.forEach(token => {
                    const concentration = (token.value / totalValue) * 100;
                    if (concentration > 70 && token.symbol !== 'SOL') {
                        showNotification(
                            `‚ö†Ô∏è High concentration risk: ${token.symbol} is ${concentration.toFixed(1)}% of portfolio`,
                            'error'
                        );
                    }
                });
                
                // Check for MEV risk on large positions
                const largePositions = tokens.filter(token => token.value > 10000);
                if (largePositions.length > 0) {
                    // Simulate MEV protection suggestions
                    if (Math.random() < 0.05) { // 5% chance
                        showNotification(
                            'üõ°Ô∏è MEV Protection: Consider splitting large trades to avoid front-running',
                            'info'
                        );
                    }
                }
            }, 120000); // Check every 2 minutes
        }

        // Market sentiment tracking
        function trackMarketSentiment() {
            setInterval(async () => {
                try {
                    const marketData = await getMarketData();
                    if (marketData) {
                        const fearGreedIndex = Math.random() * 100; // Simplified sentiment
                        
                        if (fearGreedIndex < 20) {
                            showNotification('üìä Extreme Fear in market - Could be buying opportunity', 'info');
                        } else if (fearGreedIndex > 80) {
                            showNotification('üìä Extreme Greed detected - Consider taking profits', 'info');
                        }
                    }
                } catch (error) {
                    console.error('Sentiment tracking error:', error);
                }
            }, 300000); // Check every 5 minutes
        }

        // Achievement progress tracking
        function trackAchievementProgress() {
            if (!portfolioData) return;
            
            const { totalValue, solBalance, tokens } = portfolioData;
            
            // Check for new achievements
            const newAchievements = [];
            
            if (totalValue >= 10000 && !localStorage.getItem('achievement_10k')) {
                newAchievements.push('War Chest Builder: Reached $10K portfolio value!');
                localStorage.setItem('achievement_10k', 'true');
            }
            
            if (solBalance >= 50 && !localStorage.getItem('achievement_50sol')) {
                newAchievements.push('Sun Collector: Accumulated 50+ SOL!');
                localStorage.setItem('achievement_50sol', 'true');
            }
            
            if (tokens.length >= 5 && !localStorage.getItem('achievement_diversified')) {
                newAchievements.push('Diversification Chief: Holding 5+ different tokens!');
                localStorage.setItem('achievement_diversified', 'true');
            }
            
            // Show achievement notifications
            newAchievements.forEach((achievement, index) => {
                setTimeout(() => {
                    showNotification(`üèÜ Achievement Unlocked: ${achievement}`, 'success');
                }, index * 2000);
            });
        }

        // Initialize application
        window.addEventListener('load', async () => {
            createAnimatedBackground();
            
            // Check for existing wallet connections
            const providers = ['phantom', 'solflare', 'backpack'];
            
            for (const provider of providers) {
                try {
                    let wallet;
                    switch (provider) {
                        case 'phantom':
                            wallet = window.solana;
                            break;
                        case 'solflare':
                            wallet = window.solflare;
                            break;
                        case 'backpack':
                            wallet = window.backpack;
                            break;
                    }
                    
                    if (wallet && wallet.isConnected && wallet.publicKey) {
                        walletAddress = wallet.publicKey.toString();
                        walletProvider = wallet;
                        isConnected = true;
                        
                        document.getElementById('connectedWallet').textContent = formatAddress(walletAddress);
                        showNotification(`Welcome back to the tribe, warrior! Connected via ${provider} üèπ`, 'success');
                        
                        showDashboard();
                        await loadAllData();
                        await initializeChart();
                        
                        // Start background monitoring
                        startPriceMonitoring();
                        startWhaleTracking();
                        startRiskMonitoring();
                        trackMarketSentiment();
                        trackAchievementProgress();
                        
                        break;
                    }
                } catch (error) {
                    console.warn(`Failed to check ${provider} connection:`, error);
                }
            }
            
            // Load market data even without wallet connection
            await loadMarketData();
        });

        // Error handling for network issues
        window.addEventListener('offline', () => {
            showNotification('üåê Connection lost. Some features may be unavailable.', 'error');
        });

        window.addEventListener('online', () => {
            showNotification('üåê Connection restored. Refreshing data...', 'success');
            if (isConnected) {
                refreshData();
            }
        });

        // Handle wallet disconnection events
        if (window.solana) {
            window.solana.on('disconnect', () => {
                if (isConnected) {
                    disconnect();
                }
            });
        }

        // Performance optimization
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        // Debounced resize handler for responsive charts
        window.addEventListener('resize', debounce(() => {
            if (chartInstance) {
                chartInstance.resize();
            }
        }, 250));

        // Tab navigation with keyboard support
        document.addEventListener('keydown', (e) => {
            if (e.altKey && e.key >= '1' && e.key <= '7') {
                e.preventDefault();
                const tabIndex = parseInt(e.key) - 1;
                const tabs = ['overview', 'portfolio', 'traders', 'analysis', 'discovery', 'achievements', 'settings'];
                if (tabs[tabIndex] && isConnected) {
                    showTab(tabs[tabIndex]);
                }
            }
        });

        // Add click handlers for nav tabs
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.nav-tab').forEach((tab, index) => {
                tab.addEventListener('click', (e) => {
                    const tabText = e.target.textContent.trim();
                    let tabName = '';
                    if (tabText.includes('Overview')) tabName = 'overview';
                    else if (tabText.includes('Portfolio')) tabName = 'portfolio';
                    else if (tabText.includes('Warriors')) tabName = 'traders';
                    else if (tabText.includes('Analysis')) tabName = 'analysis';
                    else if (tabText.includes('Discovery')) tabName = 'discovery';
                    else if (tabText.includes('Honors')) tabName = 'achievements';
                    else if (tabText.includes('Settings')) tabName = 'settings';
                    
                    if (tabName) {
                        showTab(tabName);
                    }
                });
            });
        });

        // Analytics and usage tracking (privacy-focused)
        function trackUsage(event, data = {}) {
            // In production, this would send anonymized usage data
            console.log('Usage tracked:', event, data);
        }

        // Export global functions for HTML onclick handlers
        window.connectWallet = connectWallet;
        window.showTab = showTab;
        window.updateChart = updateChart;
        window.tradeToken = tradeToken;
        window.viewTrader = viewTrader;
        window.followTrader = followTrader;
        window.viewAchievement = viewAchievement;
        window.exploreToken = exploreToken;
        window.quickTrade = quickTrade;
        window.disconnect = disconnect;
        window.refreshData = refreshData;
        window.exportData = exportData;
        window.clearCache = clearCache;
        window.showDonation = showDonation;
        window.loadAnalysisData = loadAnalysisData;

        // Development helpers (remove in production)
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            window.portfolioData = portfolioData;
            window.API_CONFIG = API_CONFIG;
            window.KNOWN_TOKENS = KNOWN_TOKENS;
            console.log('üèπ Comanche Portfolio Tracker - Development Mode');
            console.log('Available dev tools:', {
                portfolioData: 'window.portfolioData',
                apiConfig: 'window.API_CONFIG',
                knownTokens: 'window.KNOWN_TOKENS'
            });
        }
    </script>
</body>
</html>