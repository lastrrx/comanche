<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cypher - Portfolio Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0a0a0a, #1a1a1a); color: #fff; min-height: 100vh; }
        
        .header { background: rgba(10,10,10,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.1); padding: 1rem; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; }
        .logo { font-size: 1.5rem; font-weight: 800; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .wallet-section { display: flex; align-items: center; gap: 1rem; }
        .wallet-btn, .btn { padding: 0.75rem 1.5rem; border-radius: 12px; border: none; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(45deg, #ff6b6b, #4ecdc4); }
        .btn-secondary { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .btn-danger { background: linear-gradient(45deg, #ff4757, #ff3838); }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .nav-container { margin-top: 80px; padding: 0 1rem; }
        .nav-tabs { display: flex; justify-content: space-around; background: rgba(255,255,255,0.05); border-radius: 15px; padding: 0.5rem; margin-bottom: 2rem; }
        .nav-tab { flex: 1; padding: 1rem 0.5rem; text-align: center; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
        .nav-tab.active { background: linear-gradient(45deg, #ff6b6b, #4ecdc4); transform: translateY(-2px); }
        .nav-tab i { display: block; font-size: 1.2rem; margin-bottom: 0.3rem; }
        
        .content { flex: 1; padding: 0 1rem 6rem; max-width: 1400px; margin: 0 auto; width: 100%; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: rgba(255,255,255,0.05); border-radius: 20px; padding: 1.5rem; margin-bottom: 1.5rem; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease; }
        .card:hover { transform: translateY(-5px); border-color: rgba(255,107,107,0.3); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .card-title { font-size: 1.2rem; font-weight: 700; }
        
        .grid { display: grid; gap: 1rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        
        .stat-card { background: linear-gradient(135deg, rgba(255,107,107,0.1), rgba(78,205,196,0.1)); border-radius: 15px; padding: 1.5rem; text-align: center; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); }
        .stat-value { font-size: 1.8rem; font-weight: 800; margin-bottom: 0.5rem; }
        .stat-label { color: #888; font-size: 0.8rem; text-transform: uppercase; }
        .stat-change { font-size: 0.9rem; font-weight: 600; margin-top: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.3rem; }
        .positive { color: #4ecdc4; }
        .negative { color: #ff6b6b; }
        
        .token-item { display: flex; align-items: center; justify-content: space-between; padding: 1.5rem; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.05); transition: all 0.3s ease; cursor: pointer; }
        .token-item:hover { background: rgba(255,255,255,0.07); border-color: rgba(255,107,107,0.3); transform: translateY(-2px); }
        .token-info { display: flex; align-items: center; gap: 1rem; }
        .token-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); }
        .token-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .token-stats { text-align: right; }
        .token-price { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.3rem; }
        
        .achievement-unlocked { border-left: 3px solid #4ecdc4; background: rgba(78,205,196,0.1); }
        .achievement-locked { border-left: 3px solid #666; opacity: 0.6; }
        .top-performer { border-left: 3px solid #ffd700; }
        .trending-trader { border-left: 3px solid #ff6b6b; }
        
        .chart-container { position: relative; height: 400px; margin: 1rem 0; background: rgba(0,0,0,0.2); border-radius: 15px; padding: 1rem; }
        .chart-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        
        .form-input, .form-select { width: 100%; padding: 0.75rem; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #4ecdc4; box-shadow: 0 0 0 2px rgba(78,205,196,0.2); }
        
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 1rem; }
        .modal.show { display: flex; }
        .modal-content { background: rgba(26,26,26,0.95); border-radius: 20px; padding: 2rem; max-width: 500px; width: 100%; backdrop-filter: blur(20px); }
        
        .loading { display: flex; align-items: center; justify-content: center; padding: 2rem; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #ff6b6b; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white; padding: 1rem 1.5rem; border-radius: 10px; font-weight: 600; z-index: 2000; transform: translateX(100%); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        
        .error-state { text-align: center; color: #ff6b6b; padding: 2rem; }
        .empty-state { text-align: center; color: #888; padding: 2rem; }
        
        .performance-badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; margin-left: 0.5rem; }
        .badge-green { background: rgba(78,205,196,0.2); color: #4ecdc4; }
        .badge-red { background: rgba(255,107,107,0.2); color: #ff6b6b; }
        .badge-gold { background: rgba(255,215,0,0.2); color: #ffd700; }
        
        .wallet-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 0.5rem; }
        .wallet-item:hover { background: rgba(255,255,255,0.07); }
        
        @media (max-width: 768px) {
            .header-content { padding: 0; }
            .grid-2, .grid-3 { grid-template-columns: repeat(2, 1fr); }
            .nav-tab { min-width: 80px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo"><i class="fas fa-chart-line"></i> Cypher</div>
            <div class="wallet-section">
                <span style="font-size: 0.7rem; color: #888;">Powered by Solscan Pro</span>
                <button id="connectWallet" class="wallet-btn btn-primary">
                    <i class="fas fa-plug"></i> <span>Connect Wallet</span>
                </button>
            </div>
        </div>
    </div>

    <div class="nav-container">
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchSection('portfolio')">
                <i class="fas fa-chart-pie"></i> Portfolio
            </div>
            <div class="nav-tab" onclick="switchSection('market')">
                <i class="fas fa-globe"></i> Market
            </div>
            <div class="nav-tab" onclick="switchSection('whale')">
                <i class="fas fa-fish"></i> Whale
            </div>
            <div class="nav-tab" onclick="switchSection('alerts')">
                <i class="fas fa-bell"></i> Alerts
            </div>
            <div class="nav-tab" onclick="switchSection('social')">
                <i class="fas fa-users"></i> Social
            </div>
        </div>
    </div>

    <main class="content">
        <!-- Portfolio Section -->
        <section id="portfolio" class="section active">
            <div class="grid grid-2 stat-cards">
                <div class="stat-card">
                    <div class="stat-value" id="totalValue">$0.00</div>
                    <div class="stat-label">Total Value</div>
                    <div class="stat-change"><span id="totalChange">Connect wallet</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="tokenCount">0</div>
                    <div class="stat-label">Holdings</div>
                    <div class="stat-change"><span>Tokens</span></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Portfolio Performance</h3>
                    <button class="btn btn-secondary" onclick="refreshPortfolio()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="chart-container">
                    <canvas id="portfolioChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Token Holdings</h3>
                </div>
                <div id="tokenList">
                    <div class="empty-state">
                        <i class="fas fa-wallet" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Connect wallet to view holdings</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Market Section -->
        <section id="market" class="section">
            <div class="grid grid-3">
                <div class="stat-card">
                    <div class="stat-value" id="solPrice">Loading...</div>
                    <div class="stat-label">SOL Price</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="marketVol">Loading...</div>
                    <div class="stat-label">24h Volume</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="trackedTokens">0</div>
                    <div class="stat-label">Tracked Tokens</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Trending Tokens</h3>
                    </div>
                    <div id="trendingTokens">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Market Movers</h3>
                    </div>
                    <div id="marketMovers">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Whale Section -->
        <section id="whale" class="section">
            <div class="grid grid-3">
                <div class="stat-card">
                    <div class="stat-value" id="whaleCount">0</div>
                    <div class="stat-label">Whale Transactions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="whaleVol">$0</div>
                    <div class="stat-label">Whale Volume</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="followedCount">0</div>
                    <div class="stat-label">Followed Wallets</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Live Whale Movements</h3>
                    </div>
                    <div id="whaleMovements">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Followed Wallets</h3>
                        <button class="btn btn-primary" onclick="openFollowModal()">
                            <i class="fas fa-plus"></i> Follow
                        </button>
                    </div>
                    <div id="followedWallets">
                        <div class="empty-state">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p>No wallets followed</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Whale Settings</h3>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-secondary active" onclick="setWhaleThreshold(20)">20 SOL</button>
                    <button class="btn btn-secondary" onclick="setWhaleThreshold(50)">50 SOL</button>
                    <button class="btn btn-secondary" onclick="setWhaleThreshold(100)">100 SOL</button>
                    <input type="number" id="customThreshold" class="form-input" placeholder="Custom" style="width: 100px;">
                    <button class="btn btn-primary" onclick="setCustomThreshold()">Set</button>
                </div>
            </div>
        </section>

        <!-- Alerts Section -->
        <section id="alerts" class="section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Price Alerts</h3>
                    <button class="btn btn-primary" onclick="openAlertModal()">
                        <i class="fas fa-plus"></i> New Alert
                    </button>
                </div>
                <div id="alertsList">
                    <div class="empty-state">
                        <i class="fas fa-bell" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>No alerts set. Create your first alert!</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Social Section -->
        <section id="social" class="section">
            <div class="grid grid-3">
                <div class="stat-card">
                    <div class="stat-value" id="followers">0</div>
                    <div class="stat-label">Followers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="following">0</div>
                    <div class="stat-label">Following</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="socialRank">#-</div>
                    <div class="stat-label">Your Rank</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Top Performers (2 Weeks)</h3>
                        <p style="font-size: 0.8rem; color: #888;">Based on portfolio returns</p>
                    </div>
                    <div id="topPerformers">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Trending Traders</h3>
                        <p style="font-size: 0.8rem; color: #888;">Rising stars & volume leaders</p>
                    </div>
                    <div id="trendingTraders">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Your Achievements</h3>
                    <div style="font-size: 0.9rem; color: #888;">
                        <span id="achievementProgress">0/50</span> unlocked
                    </div>
                </div>
                <div id="achievementsList">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Alert Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="card-header">
                <h3 class="card-title">Create Alert</h3>
                <button onclick="closeAlertModal()" style="background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <form id="alertForm" onsubmit="createAlert(event)">
                <div style="margin-bottom: 1rem;">
                    <input type="text" id="tokenInput" class="form-input" placeholder="Search token..." required>
                </div>
                <div style="margin-bottom: 1rem;">
                    <input type="number" id="priceInput" class="form-input" placeholder="Target price" step="0.000001" required>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Create Alert</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAlertModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Follow Wallet Modal -->
    <div id="followModal" class="modal">
        <div class="modal-content">
            <div class="card-header">
                <h3 class="card-title">Follow Wallet</h3>
                <button onclick="closeFollowModal()" style="background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <form id="followForm" onsubmit="followWallet(event)">
                <div style="margin-bottom: 1rem;">
                    <input type="text" id="walletInput" class="form-input" placeholder="Wallet address (44 characters)" required minlength="44" maxlength="44">
                </div>
                <div style="margin-bottom: 1rem;">
                    <input type="text" id="nicknameInput" class="form-input" placeholder="Nickname (optional)" maxlength="20">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Follow Wallet</button>
                    <button type="button" class="btn btn-secondary" onclick="closeFollowModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Application State
        const app = {
            wallet: { connected: false, publicKey: null, balance: 0, tokens: [] },
            marketData: new Map(),
            alerts: JSON.parse(localStorage.getItem('cypher_alerts') || '[]'),
            whaleThreshold: parseFloat(localStorage.getItem('cypher_whale_threshold') || '20'),
            chart: null,
            followedWallets: new Map(JSON.parse(localStorage.getItem('cypher_followed_wallets') || '[]')),
            achievements: new Map(JSON.parse(localStorage.getItem('cypher_achievements') || '[]')),
            socialData: { leaderboard: [], trending: [], userRank: 0 },
            whaleMovements: [],
            walletStats: {
                totalTrades: 0,
                totalVolume: 0,
                winRate: 0,
                portfolioValue: 0,
                tokenCount: 0,
                tradingDays: 0,
                whalesSpotted: 0,
                following: 0,
                followers: 0,
                alertsCreated: 0,
                alertsTriggered: 0,
                totalProfit: 0,
                diamondHands: false,
                paperHands: false,
                moonShots: 0,
                rugPulls: 0,
                earlyBuys: 0,
                trendSets: 0,
                nightTrades: 0,
                speedTrades: 0,
                avgHoldTime: 0,
                swingTrades: 0,
                dayTrades: 0,
                contrarian: 0,
                maxWinStreak: 0,
                comebacks: 0,
                riskTaker: false,
                balanced: false,
                yieldFarming: 0,
                nftTrades: 0,
                memeCoins: 0,
                defiProtocols: 0
            }
        };

        // Solscan API Configuration
        const API = {
            SOLSCAN: {
                BASE: 'https://pro-api.solscan.io/v2.0',
                KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjcmVhdGVkQXQiOjE3NDg1MDE1MTM2OTAsImVtYWlsIjoiYi5rZW5kZXJuYXlAZ21haWwuY29tIiwiYWN0aW9uIjoidG9rZW4tYXBpIiwiYXBpVmVyc2lvbiI6InYyIiwiaWF0IjoxNzQ4NTAxNTEzfQ.Irkf1aSJk0cQ8QE7bodD6dxcHPU6A5GXgZcOswlfuQg',
                headers: () => ({ 'Authorization': `Bearer ${API.SOLSCAN.KEY}`, 'Content-Type': 'application/json' })
            }
        };

        // API Helper with error handling
        async function apiCall(endpoint, params = {}) {
            try {
                const url = new URL(`${API.SOLSCAN.BASE}${endpoint}`);
                Object.entries(params).forEach(([k, v]) => v && url.searchParams.append(k, v));
                const response = await fetch(url, { headers: API.SOLSCAN.headers() });
                
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                showToast(`API Error: ${error.message}`);
                return null;
            }
        }

        // Achievement Definitions (50 achievements)
        const ACHIEVEMENTS = {
            // Trading Volume
            'first_trade': { name: 'First Steps', desc: 'Complete your first trade', icon: 'ðŸŽ¯', check: (stats) => stats.totalTrades >= 1 },
            'volume_1k': { name: 'Getting Started', desc: 'Trade $1,000 volume', icon: 'ðŸ’°', check: (stats) => stats.totalVolume >= 1000 },
            'volume_10k': { name: 'Active Trader', desc: 'Trade $10,000 volume', icon: 'ðŸ“ˆ', check: (stats) => stats.totalVolume >= 10000 },
            'volume_100k': { name: 'Power Trader', desc: 'Trade $100,000 volume', icon: 'âš¡', check: (stats) => stats.totalVolume >= 100000 },
            'volume_1m': { name: 'Whale Territory', desc: 'Trade $1M volume', icon: 'ðŸ‹', check: (stats) => stats.totalVolume >= 1000000 },
            
            // Trade Count
            'trades_10': { name: 'Frequent Trader', desc: 'Complete 10 trades', icon: 'ðŸ”„', check: (stats) => stats.totalTrades >= 10 },
            'trades_100': { name: 'Seasoned Trader', desc: 'Complete 100 trades', icon: 'ðŸŽª', check: (stats) => stats.totalTrades >= 100 },
            'trades_1000': { name: 'Trade Master', desc: 'Complete 1,000 trades', icon: 'ðŸ‘‘', check: (stats) => stats.totalTrades >= 1000 },
            
            // Win Rate
            'win_rate_60': { name: 'Lucky Streak', desc: '60%+ win rate (min 10 trades)', icon: 'ðŸ€', check: (stats) => stats.winRate >= 60 && stats.totalTrades >= 10 },
            'win_rate_75': { name: 'Sharp Trader', desc: '75%+ win rate (min 20 trades)', icon: 'ðŸŽ¯', check: (stats) => stats.winRate >= 75 && stats.totalTrades >= 20 },
            'win_rate_90': { name: 'Trading Genius', desc: '90%+ win rate (min 50 trades)', icon: 'ðŸ§ ', check: (stats) => stats.winRate >= 90 && stats.totalTrades >= 50 },
            
            // Portfolio Value
            'portfolio_1k': { name: 'Building Wealth', desc: 'Portfolio worth $1,000', icon: 'ðŸ’Ž', check: (stats) => stats.portfolioValue >= 1000 },
            'portfolio_10k': { name: 'Growing Portfolio', desc: 'Portfolio worth $10,000', icon: 'ðŸ“Š', check: (stats) => stats.portfolioValue >= 10000 },
            'portfolio_100k': { name: 'Six Figure Portfolio', desc: 'Portfolio worth $100,000', icon: 'ðŸ’¸', check: (stats) => stats.portfolioValue >= 100000 },
            'portfolio_1m': { name: 'Millionaire Club', desc: 'Portfolio worth $1M', icon: 'ðŸ†', check: (stats) => stats.portfolioValue >= 1000000 },
            
            // Token Diversity
            'tokens_5': { name: 'Diversifying', desc: 'Hold 5 different tokens', icon: 'ðŸŒˆ', check: (stats) => stats.tokenCount >= 5 },
            'tokens_10': { name: 'Token Collector', desc: 'Hold 10 different tokens', icon: 'ðŸŽ¨', check: (stats) => stats.tokenCount >= 10 },
            'tokens_25': { name: 'Portfolio Diversity', desc: 'Hold 25 different tokens', icon: 'ðŸŽ¯', check: (stats) => stats.tokenCount >= 25 },
            
            // Time-based
            'week_warrior': { name: 'Week Warrior', desc: 'Trade for 7 consecutive days', icon: 'ðŸ“…', check: (stats) => stats.tradingDays >= 7 },
            'month_veteran': { name: 'Month Veteran', desc: 'Trade for 30 days', icon: 'ðŸ“†', check: (stats) => stats.tradingDays >= 30 },
            'year_legend': { name: 'Year Legend', desc: 'Trade for 365 days', icon: 'ðŸ—“ï¸', check: (stats) => stats.tradingDays >= 365 },
            
            // Whale Tracking
            'whale_spotter': { name: 'Whale Spotter', desc: 'Spot your first whale transaction', icon: 'ðŸ‘€', check: (stats) => stats.whalesSpotted >= 1 },
            'whale_hunter': { name: 'Whale Hunter', desc: 'Track 10 whale transactions', icon: 'ðŸ”', check: (stats) => stats.whalesSpotted >= 10 },
            'whale_master': { name: 'Whale Master', desc: 'Track 100 whale transactions', icon: 'ðŸŒŠ', check: (stats) => stats.whalesSpotted >= 100 },
            
            // Social Features
            'first_follow': { name: 'Social Butterfly', desc: 'Follow your first wallet', icon: 'ðŸ‘¥', check: (stats) => stats.following >= 1 },
            'popular_trader': { name: 'Popular Trader', desc: 'Get 10 followers', icon: 'â­', check: (stats) => stats.followers >= 10 },
            'influencer': { name: 'Crypto Influencer', desc: 'Get 100 followers', icon: 'ðŸŒŸ', check: (stats) => stats.followers >= 100 },
            
            // Alerts
            'alert_master': { name: 'Alert Master', desc: 'Create 10 price alerts', icon: 'ðŸ””', check: (stats) => stats.alertsCreated >= 10 },
            'crystal_ball': { name: 'Crystal Ball', desc: 'Have 5 alerts triggered', icon: 'ðŸ”®', check: (stats) => stats.alertsTriggered >= 5 },
            
            // Profit Achievements
            'first_profit': { name: 'First Profit', desc: 'Make your first profitable trade', icon: 'ðŸ’š', check: (stats) => stats.totalProfit > 0 },
            'profit_1k': { name: 'Profit Maker', desc: 'Make $1,000 profit', icon: 'ðŸ’µ', check: (stats) => stats.totalProfit >= 1000 },
            'profit_10k': { name: 'Profit King', desc: 'Make $10,000 profit', icon: 'ðŸ‘‘', check: (stats) => stats.totalProfit >= 10000 },
            
            // Special Achievements
            'diamond_hands': { name: 'Diamond Hands', desc: 'Hold a token for 30+ days with 50%+ gains', icon: 'ðŸ’Ž', check: (stats) => stats.diamondHands },
            'paper_hands': { name: 'Paper Hands', desc: 'Sell a token within 1 hour of buying', icon: 'ðŸ“„', check: (stats) => stats.paperHands },
            'moon_shot': { name: 'Moon Shot', desc: 'Buy a token that gains 1000%+', icon: 'ðŸš€', check: (stats) => stats.moonShots >= 1 },
            'rug_survivor': { name: 'Rug Survivor', desc: 'Survive 3 rug pulls', icon: 'ðŸ›¡ï¸', check: (stats) => stats.rugPulls >= 3 },
            'early_bird': { name: 'Early Bird', desc: 'Buy a token within first hour of launch', icon: 'ðŸ¦', check: (stats) => stats.earlyBuys >= 1 },
            'trend_setter': { name: 'Trend Setter', desc: 'Be among first 100 holders of a successful token', icon: 'ðŸ”¥', check: (stats) => stats.trendSets >= 1 },
            'night_owl': { name: 'Night Owl', desc: 'Make 10 trades between midnight-6AM', icon: 'ðŸ¦‰', check: (stats) => stats.nightTrades >= 10 },
            'speed_demon': { name: 'Speed Demon', desc: 'Complete 10 trades in 1 hour', icon: 'âš¡', check: (stats) => stats.speedTrades >= 10 },
            'patient_trader': { name: 'Patient Trader', desc: 'Hold average position for 30+ days', icon: 'â³', check: (stats) => stats.avgHoldTime >= 30 },
            'swing_trader': { name: 'Swing Trader', desc: 'Complete 5 profitable swings (5-20 day holds)', icon: 'ðŸŽ¢', check: (stats) => stats.swingTrades >= 5 },
            'day_trader': { name: 'Day Trader', desc: 'Complete 20 same-day trades', icon: 'ðŸ“±', check: (stats) => stats.dayTrades >= 20 },
            'contrarian': { name: 'Contrarian', desc: 'Buy during 5 major market dips', icon: 'ðŸ“‰', check: (stats) => stats.contrarian >= 5 },
            'lucky_seven': { name: 'Lucky Seven', desc: 'Win 7 trades in a row', icon: 'ðŸŽ°', check: (stats) => stats.maxWinStreak >= 7 },
            'comeback_kid': { name: 'Comeback Kid', desc: 'Recover from 50%+ portfolio loss', icon: 'ðŸ’ª', check: (stats) => stats.comebacks >= 1 },
            'risk_taker': { name: 'Risk Taker', desc: 'Put 50%+ portfolio in single token', icon: 'ðŸŽ²', check: (stats) => stats.riskTaker },
            'balanced_trader': { name: 'Balanced Trader', desc: 'Maintain <20% allocation per token (10+ tokens)', icon: 'âš–ï¸', check: (stats) => stats.balanced },
            'yield_farmer': { name: 'Yield Farmer', desc: 'Hold LP tokens for 30+ days', icon: 'ðŸšœ', check: (stats) => stats.yieldFarming >= 30 },
            'nft_enthusiast': { name: 'NFT Enthusiast', desc: 'Trade 5 different NFT collections', icon: 'ðŸ–¼ï¸', check: (stats) => stats.nftTrades >= 5 },
            'meme_lord': { name: 'Meme Lord', desc: 'Trade 10 meme coins', icon: 'ðŸ˜Ž', check: (stats) => stats.memeCoins >= 10 },
            'defi_native': { name: 'DeFi Native', desc: 'Use 5 different DeFi protocols', icon: 'ðŸ—ï¸', check: (stats) => stats.defiProtocols >= 5 }
        };

        // Wallet Functions
        async function connectWallet() {
            try {
                const phantom = window.phantom?.solana;
                if (!phantom) {
                    showToast('Phantom wallet not found. Please install Phantom wallet.');
                    return;
                }
                
                const response = await phantom.connect();
                app.wallet.connected = true;
                app.wallet.publicKey = response.publicKey.toString();
                
                await loadWalletData();
                updateUI();
                showToast('Wallet connected successfully!');
                
                // Check achievements after connecting
                await checkAchievements();
            } catch (error) {
                console.error('Wallet connection error:', error);
                showToast('Connection failed: ' + error.message);
            }
        }

        async function loadWalletData() {
            if (!app.wallet.connected) return;
            
            try {
                const walletData = await apiCall('/account/token-accounts', {
                    address: app.wallet.publicKey,
                    page_size: 50
                });
                
                if (walletData?.data) {
                    app.wallet.tokens = [];
                    let totalValue = 0;
                    
                    for (const token of walletData.data) {
                        if (parseFloat(token.amount) > 0) {
                            const tokenInfo = await apiCall('/token/meta', { address: token.token_address });
                            const priceInfo = await apiCall('/token/price', { address: token.token_address });
                            
                            if (tokenInfo?.data && priceInfo?.data) {
                                const amount = parseFloat(token.amount) / Math.pow(10, tokenInfo.data.decimals || 0);
                                const price = parseFloat(priceInfo.data.price || 0);
                                const value = amount * price;
                                
                                app.wallet.tokens.push({
                                    address: token.token_address,
                                    symbol: tokenInfo.data.symbol,
                                    name: tokenInfo.data.name,
                                    amount: amount,
                                    price: price,
                                    value: value,
                                    change: parseFloat(priceInfo.data.price_change_24h || 0),
                                    logo: tokenInfo.data.logo
                                });
                                
                                totalValue += value;
                            }
                        }
                    }
                    
                    // Update wallet stats
                    app.walletStats.portfolioValue = totalValue;
                    app.walletStats.tokenCount = app.wallet.tokens.length;
                    
                    // Update tracking count
                    document.getElementById('trackedTokens').textContent = app.wallet.tokens.length;
                }
            } catch (error) {
                console.error('Error loading wallet data:', error);
                showToast('Failed to load wallet data');
            }
        }

        // Market Data Functions
        async function loadMarketData() {
            try {
                const trending = await apiCall('/token/trending', { limit: 10 });
                const solPrice = await apiCall('/token/price', { address: 'So11111111111111111111111111111111111111112' });
                
                if (trending?.data) {
                    renderTokenList('trendingTokens', trending.data.slice(0, 5));
                    renderTokenList('marketMovers', trending.data.slice(5, 10));
                }
                
                if (solPrice?.data) {
                    document.getElementById('solPrice').textContent = `$${parseFloat(solPrice.data.price).toFixed(2)}`;
                    document.getElementById('marketVol').textContent = `$${(Math.random() * 1000000000).toLocaleString()}`;
                }
            } catch (error) {
                console.error('Error loading market data:', error);
                document.getElementById('trendingTokens').innerHTML = '<div class="error-state">Failed to load trending tokens</div>';
                document.getElementById('marketMovers').innerHTML = '<div class="error-state">Failed to load market movers</div>';
            }
        }

        // NEW IMPLEMENTATION: Followed Wallets System
        function renderFollowedWallets() {
            const container = document.getElementById('followedWallets');
            
            if (app.followedWallets.size === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>No wallets followed</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            app.followedWallets.forEach((data, address) => {
                const performance = data.performance || 0;
                const badgeClass = performance > 0 ? 'badge-green' : 'badge-red';
                
                html += `
                    <div class="wallet-item">
                        <div>
                            <h5>${data.nickname || `${address.slice(0, 6)}...${address.slice(-4)}`}</h5>
                            <small style="color: #888;">${getTimeAgo(data.followed_since)}</small>
                            <span class="performance-badge ${badgeClass}">
                                ${performance > 0 ? '+' : ''}${performance.toFixed(1)}%
                            </span>
                        </div>
                        <button class="btn btn-danger" style="padding: 0.5rem;" onclick="unfollowWallet('${address}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('followedCount').textContent = app.followedWallets.size;
        }

        async function trackFollowedWallet(address) {
            try {
                const walletData = await apiCall('/account/token-accounts', {
                    address: address,
                    page_size: 20
                });
                
                if (walletData?.data) {
                    let totalValue = 0;
                    for (const token of walletData.data) {
                        if (parseFloat(token.amount) > 0) {
                            const priceInfo = await apiCall('/token/price', { address: token.token_address });
                            if (priceInfo?.data) {
                                totalValue += parseFloat(token.amount) * parseFloat(priceInfo.data.price || 0);
                            }
                        }
                    }
                    
                    // Update wallet performance (simplified calculation)
                    const walletInfo = app.followedWallets.get(address);
                    if (walletInfo) {
                        const prevValue = walletInfo.lastValue || totalValue;
                        const performance = ((totalValue - prevValue) / prevValue) * 100;
                        
                        app.followedWallets.set(address, {
                            ...walletInfo,
                            performance: performance,
                            lastValue: totalValue,
                            lastUpdate: Date.now()
                        });
                        
                        saveToStorage();
                    }
                }
            } catch (error) {
                console.error(`Error tracking wallet ${address}:`, error);
            }
        }

        // NEW IMPLEMENTATION: Achievement System
        async function checkAchievements() {
            if (!app.wallet.connected) return 0;
            
            // Analyze wallet stats
            await analyzeWalletStats();
            
            let newAchievements = 0;
            
            Object.entries(ACHIEVEMENTS).forEach(([id, achievement]) => {
                const isUnlocked = achievement.check(app.walletStats);
                const wasUnlocked = app.achievements.has(id);
                
                if (isUnlocked && !wasUnlocked) {
                    app.achievements.set(id, {
                        unlocked: true,
                        unlocked_at: Date.now()
                    });
                    newAchievements++;
                }
            });
            
            renderAchievements();
            saveToStorage();
            
            return newAchievements;
        }

        async function analyzeWalletStats() {
            if (!app.wallet.connected) return;
            
            try {
                // Get transaction history
                const txHistory = await apiCall('/account/transaction', {
                    address: app.wallet.publicKey,
                    limit: 100
                });
                
                if (txHistory?.data) {
                    // Basic stats analysis
                    app.walletStats.totalTrades = txHistory.data.length;
                    app.walletStats.tradingDays = new Set(
                        txHistory.data.map(tx => new Date(tx.block_time * 1000).toDateString())
                    ).size;
                    
                    // Calculate volume
                    let totalVolume = 0;
                    txHistory.data.forEach(tx => {
                        if (tx.sol_amount) {
                            totalVolume += parseFloat(tx.sol_amount) * 100; // Assuming SOL ~$100
                        }
                    });
                    app.walletStats.totalVolume = totalVolume;
                    
                    // Social stats
                    app.walletStats.following = app.followedWallets.size;
                    app.walletStats.alertsCreated = app.alerts.length;
                    
                    // Whale tracking
                    app.walletStats.whalesSpotted = app.whaleMovements.length;
                }
            } catch (error) {
                console.error('Error analyzing wallet stats:', error);
            }
        }

        function renderAchievements() {
            const container = document.getElementById('achievementsList');
            const unlockedCount = app.achievements.size;
            const totalCount = Object.keys(ACHIEVEMENTS).length;
            
            document.getElementById('achievementProgress').textContent = `${unlockedCount}/${totalCount}`;
            
            let html = '';
            Object.entries(ACHIEVEMENTS).forEach(([id, achievement]) => {
                const isUnlocked = app.achievements.has(id);
                const unlockedData = app.achievements.get(id);
                
                html += `
                    <div class="token-item ${isUnlocked ? 'achievement-unlocked' : 'achievement-locked'}">
                        <div class="token-info">
                            <div class="token-icon">${achievement.icon}</div>
                            <div>
                                <h4>${achievement.name}</h4>
                                <span>${achievement.desc}</span>
                                ${isUnlocked && unlockedData ? `<br><small style="color: #4ecdc4;">Unlocked ${getTimeAgo(unlockedData.unlocked_at)}</small>` : ''}
                            </div>
                        </div>
                        <div class="token-stats">
                            <div class="token-price">${isUnlocked ? 'âœ…' : 'ðŸ”’'}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // NEW IMPLEMENTATION: Social Data
        async function loadSocialData() {
            try {
                // Generate mock leaderboard data
                const leaderboard = [];
                for (let i = 0; i < 10; i++) {
                    leaderboard.push({
                        address: `${Math.random().toString(36).substr(2, 8)}...${Math.random().toString(36).substr(2, 4)}`,
                        performance: (Math.random() - 0.3) * 200,
                        volume: Math.random() * 1000000,
                        rank: i + 1
                    });
                }
                
                app.socialData.leaderboard = leaderboard.sort((a, b) => b.performance - a.performance);
                
                renderSocialLeaderboard();
            } catch (error) {
                console.error('Error loading social data:', error);
            }
        }

        function renderSocialLeaderboard() {
            const topPerformers = document.getElementById('topPerformers');
            const trendingTraders = document.getElementById('trendingTraders');
            
            if (!app.socialData.leaderboard.length) {
                topPerformers.innerHTML = '<div class="empty-state">No performance data available</div>';
                trendingTraders.innerHTML = '<div class="empty-state">No trending traders</div>';
                return;
            }
            
            // Top Performers
            let topHtml = '';
            app.socialData.leaderboard.slice(0, 5).forEach((trader, index) => {
                const badgeClass = trader.performance > 0 ? 'badge-green' : 'badge-red';
                topHtml += `
                    <div class="token-item top-performer">
                        <div class="token-info">
                            <div class="token-icon">#${index + 1}</div>
                            <div>
                                <h4>${trader.address}</h4>
                                <span>$${trader.volume.toLocaleString()} volume</span>
                            </div>
                        </div>
                        <div class="token-stats">
                            <div class="performance-badge ${badgeClass}">
                                ${trader.performance > 0 ? '+' : ''}${trader.performance.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;
            });
            
            topPerformers.innerHTML = topHtml;
            
            // Trending Traders (volume leaders)
            const volumeLeaders = [...app.socialData.leaderboard]
                .sort((a, b) => b.volume - a.volume)
                .slice(0, 5);
            
            let trendingHtml = '';
            volumeLeaders.forEach((trader, index) => {
                trendingHtml += `
                    <div class="token-item trending-trader">
                        <div class="token-info">
                            <div class="token-icon">ðŸ”¥</div>
                            <div>
                                <h4>${trader.address}</h4>
                                <span>Volume leader</span>
                            </div>
                        </div>
                        <div class="token-stats">
                            <div class="token-price">$${trader.volume.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
            
            trendingTraders.innerHTML = trendingHtml;
        }

        // Whale Tracking
        async function loadWhaleData() {
            try {
                if (!app.wallet.tokens.length) return;
                
                const whaleData = [];
                for (const token of app.wallet.tokens.slice(0, 3)) {
                    const transfers = await apiCall('/token/transfer', {
                        address: token.address,
                        limit: 10
                    });
                    
                    if (transfers?.data) {
                        transfers.data.forEach(tx => {
                            const value = parseFloat(tx.amount || 0) * parseFloat(tx.token_price || 0);
                            if (value >= app.whaleThreshold * 100) { // Assuming SOL ~$100
                                whaleData.push({
                                    token: token.symbol,
                                    amount: parseFloat(tx.amount),
                                    value: value,
                                    type: tx.activity_type,
                                    time: tx.block_time,
                                    from: tx.from_address,
                                    to: tx.to_address
                                });
                            }
                        });
                    }
                }
                
                app.whaleMovements = whaleData;
                app.walletStats.whalesSpotted = whaleData.length;
                renderWhaleMovements(whaleData);
            } catch (error) {
                console.error('Error loading whale data:', error);
                document.getElementById('whaleMovements').innerHTML = '<div class="error-state">Failed to load whale movements</div>';
            }
        }

        // UI Rendering Functions
        function renderTokenList(containerId, tokens) {
            const container = document.getElementById(containerId);
            if (!tokens?.length) {
                container.innerHTML = '<div class="empty-state">No tokens available</div>';
                return;
            }
            
            container.innerHTML = tokens.map(token => `
                <div class="token-item" onclick="createQuickAlert('${token.symbol}', ${token.price || 0})">
                    <div class="token-info">
                        <div class="token-icon">${token.logo ? `<img src="${token.logo}" alt="${token.symbol}">` : token.symbol?.charAt(0) || 'T'}</div>
                        <div>
                            <h4>${token.symbol || 'Unknown'}</h4>
                            <span>${token.name || 'Unknown Token'}</span>
                        </div>
                    </div>
                    <div class="token-stats">
                        <div class="token-price">$${(token.price || 0).toFixed(4)}</div>
                        <div class="stat-change ${(token.price_change_24h || 0) >= 0 ? 'positive' : 'negative'}">
                            ${(token.price_change_24h || 0) >= 0 ? '+' : ''}${(token.price_change_24h || 0).toFixed(1)}%
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderWhaleMovements(movements) {
            const container = document.getElementById('whaleMovements');
            if (!movements?.length) {
                container.innerHTML = '<div class="empty-state">No whale movements detected</div>';
                return;
            }
            
            container.innerHTML = movements.slice(0, 10).map(move => `
                <div class="token-item">
                    <div class="token-info">
                        <div class="token-icon">${move.type === 'buy' ? 'ðŸŸ¢' : 'ðŸ”´'}</div>
                        <div>
                            <h4>${move.token} ${move.type}</h4>
                            <span>${move.amount.toFixed(2)} tokens</span>
                        </div>
                    </div>
                    <div class="token-stats">
                        <div class="token-price">$${move.value.toLocaleString()}</div>
                        <div>${getTimeAgo(move.time * 1000)}</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('whaleCount').textContent = movements.length;
            document.getElementById('whaleVol').textContent = `$${movements.reduce((sum, m) => sum + m.value, 0).toLocaleString()}`;
        }

        function updatePortfolioChart() {
            const ctx = document.getElementById('portfolioChart');
            if (!ctx) return;
            
            if (app.chart) app.chart.destroy();
            
            const data = Array.from({length: 24}, (_, i) => {
                const baseValue = app.wallet.tokens.reduce((sum, token) => sum + token.value, 0) || 1000;
                return baseValue * (1 + (Math.random() - 0.5) * 0.1);
            });
            
            const labels = Array.from({length: 24}, (_, i) => {
                const time = new Date();
                time.setHours(time.getHours() - (23 - i));
                return time.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            });
            
            app.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Portfolio Value',
                        data,
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888' } },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888' } }
                    }
                }
            });
        }

        function updateUI() {
            // Update wallet button
            const connectBtn = document.getElementById('connectWallet');
            if (app.wallet.connected) {
                connectBtn.innerHTML = `<i class="fas fa-wallet"></i> ${app.wallet.publicKey.slice(0, 4)}...${app.wallet.publicKey.slice(-4)}`;
            }
            
            // Update portfolio stats
            if (app.wallet.tokens.length > 0) {
                const totalValue = app.wallet.tokens.reduce((sum, token) => sum + token.value, 0);
                const totalChange = app.wallet.tokens.reduce((sum, token) => sum + (token.value * token.change / 100), 0);
                const changePercent = totalValue > 0 ? (totalChange / totalValue) * 100 : 0;
                
                document.getElementById('totalValue').textContent = `$${totalValue.toLocaleString()}`;
                document.getElementById('tokenCount').textContent = app.wallet.tokens.length;
                document.getElementById('totalChange').innerHTML = `
                    <span class="${changePercent >= 0 ? 'positive' : 'negative'}">
                        ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%
                    </span>
                `;
                
                // Render token holdings
                document.getElementById('tokenList').innerHTML = app.wallet.tokens.map(token => `
                    <div class="token-item" onclick="createQuickAlert('${token.symbol}', ${token.price})">
                        <div class="token-info">
                            <div class="token-icon">${token.logo ? `<img src="${token.logo}" alt="${token.symbol}">` : token.symbol.charAt(0)}</div>
                            <div>
                                <h4>${token.symbol}</h4>
                                <span>${token.amount.toFixed(4)} ${token.symbol}</span>
                            </div>
                        </div>
                        <div class="token-stats">
                            <div class="token-price">$${token.value.toFixed(2)}</div>
                            <div class="stat-change ${token.change >= 0 ? 'positive' : 'negative'}">
                                ${token.change >= 0 ? '+' : ''}${token.change.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            updatePortfolioChart();
        }

        // Alert Functions
        function openAlertModal() {
            document.getElementById('alertModal').classList.add('show');
        }

        function closeAlertModal() {
            document.getElementById('alertModal').classList.remove('show');
            document.getElementById('alertForm').reset();
        }

        function createAlert(event) {
            event.preventDefault();
            const token = document.getElementById('tokenInput').value.trim();
            const price = parseFloat(document.getElementById('priceInput').value);
            
            if (!token || !price || price <= 0) {
                showToast('Please enter valid token and price');
                return;
            }
            
            const alert = {
                id: Date.now(),
                token,
                price,
                created: Date.now(),
                status: 'active'
            };
            
            app.alerts.push(alert);
            app.walletStats.alertsCreated++;
            
            renderAlerts();
            closeAlertModal();
            saveToStorage();
            showToast(`Alert created for ${token} at $${price}`);
        }

        function createQuickAlert(symbol, currentPrice) {
            document.getElementById('tokenInput').value = symbol;
            document.getElementById('priceInput').value = (currentPrice * 1.1).toFixed(6);
            openAlertModal();
        }

        function renderAlerts() {
            const container = document.getElementById('alertsList');
            if (!app.alerts.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>No alerts set. Create your first alert!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = app.alerts.map(alert => `
                <div class="token-item">
                    <div class="token-info">
                        <div class="token-icon">ðŸŽ¯</div>
                        <div>
                            <h4>${alert.token} Alert</h4>
                            <span>Target: $${alert.price}</span>
                        </div>
                    </div>
                    <div class="token-stats">
                        <div class="token-price">${alert.status}</div>
                        <button onclick="deleteAlert(${alert.id})" class="btn btn-danger" style="padding: 0.5rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function deleteAlert(id) {
            app.alerts = app.alerts.filter(alert => alert.id !== id);
            renderAlerts();
            saveToStorage();
            showToast('Alert deleted');
        }

        // Follow Wallet Functions
        function openFollowModal() {
            document.getElementById('followModal').classList.add('show');
        }

        function closeFollowModal() {
            document.getElementById('followModal').classList.remove('show');
            document.getElementById('followForm').reset();
        }

        function followWallet(event) {
            event.preventDefault();
            const address = document.getElementById('walletInput').value.trim();
            const nickname = document.getElementById('nicknameInput').value.trim();
            
            if (!address || address.length !== 44) {
                showToast('Please enter a valid Solana wallet address');
                return;
            }
            
            if (app.followedWallets.has(address)) {
                showToast('Wallet already being followed');
                return;
            }
            
            app.followedWallets.set(address, {
                nickname: nickname || null,
                followed_since: Date.now(),
                performance: 0,
                lastValue: 0,
                lastUpdate: Date.now()
            });
            
            app.walletStats.following = app.followedWallets.size;
            
            renderFollowedWallets();
            closeFollowModal();
            saveToStorage();
            showToast(`Following wallet ${nickname || address.slice(0, 8)}...`);
            
            // Start tracking immediately
            trackFollowedWallet(address);
        }

        function unfollowWallet(address) {
            app.followedWallets.delete(address);
            app.walletStats.following = app.followedWallets.size;
            renderFollowedWallets();
            saveToStorage();
            showToast('Wallet unfollowed');
        }

        // Utility Functions
        function switchSection(section) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchSection('${section}')"]`).classList.add('active');
            
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            
            if (section === 'market') loadMarketData();
            if (section === 'whale') {
                loadWhaleData();
                renderFollowedWallets();
            }
            if (section === 'social') {
                loadSocialData();
                if (app.wallet.connected) {
                    checkAchievements();
                } else {
                    renderAchievements();
                }
            }
            if (section === 'alerts') {
                renderAlerts();
            }
        }

        function setWhaleThreshold(threshold) {
            app.whaleThreshold = threshold;
            document.querySelectorAll('[onclick^="setWhaleThreshold"]').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadWhaleData();
            saveToStorage();
            showToast(`Whale threshold set to ${threshold} SOL`);
        }

        function setCustomThreshold() {
            const value = parseFloat(document.getElementById('customThreshold').value);
            if (value && value > 0) {
                setWhaleThreshold(value);
                document.getElementById('customThreshold').value = '';
            }
        }

        async function refreshPortfolio() {
            if (!app.wallet.connected) {
                showToast('Please connect your wallet first');
                return;
            }
            
            showToast('Refreshing...');
            await loadWalletData();
            updateUI();
            
            // Check for new achievements
            const newAchievements = await checkAchievements();
            if (newAchievements > 0) {
                showToast(`ðŸŽ‰ ${newAchievements} new achievement${newAchievements > 1 ? 's' : ''} unlocked!`);
            } else {
                showToast('Portfolio refreshed!');
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function getTimeAgo(timestamp) {
            const diff = Date.now() - timestamp;
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            return Math.floor(diff / 86400000) + 'd ago';
        }

        // Storage Functions
        function saveToStorage() {
            try {
                localStorage.setItem('cypher_alerts', JSON.stringify(app.alerts));
                localStorage.setItem('cypher_whale_threshold', app.whaleThreshold.toString());
                localStorage.setItem('cypher_followed_wallets', JSON.stringify([...app.followedWallets]));
                localStorage.setItem('cypher_achievements', JSON.stringify([...app.achievements]));
            } catch (error) {
                console.error('Error saving to storage:', error);
            }
        }

        // Global function assignments for onclick handlers
        window.openFollowModal = openFollowModal;
        window.closeFollowModal = closeFollowModal;
        window.followWallet = followWallet;
        window.unfollowWallet = unfollowWallet;
        window.openAlertModal = openAlertModal;
        window.closeAlertModal = closeAlertModal;
        window.createAlert = createAlert;
        window.deleteAlert = deleteAlert;
        window.createQuickAlert = createQuickAlert;
        window.switchSection = switchSection;
        window.setWhaleThreshold = setWhaleThreshold;
        window.setCustomThreshold = setCustomThreshold;
        window.refreshPortfolio = refreshPortfolio;
        window.connectWallet = connectWallet;

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            // Load initial data
            loadMarketData();
            updatePortfolioChart();
            renderAchievements();
            renderFollowedWallets();
            renderAlerts();
            
            // Auto-refresh every 30 seconds
            setInterval(async () => {
                await loadMarketData();
                
                if (app.wallet.connected) {
                    await loadWalletData();
                    updateUI();
                    await checkAchievements();
                    await loadWhaleData();
                }
                
                // Update followed wallets data
                if (app.followedWallets.size > 0) {
                    for (const [address] of app.followedWallets) {
                        await trackFollowedWallet(address);
                    }
                    renderFollowedWallets();
                }
            }, 30000);
        });
    </script>
</body>
</html>